<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta name="keywords" content="DBFlute,スキーマ差分,DB差分,DB変更,データの差分,権限の差分" />
	<link rel="stylesheet" type="text/css" href="../../../../../../css/sub.css" />
	<!--[if IE 6.0]>
		<link rel="stylesheet" type="text/css" href="../../../../../../css/cb/sub.css" />
	<![endif]--> 
	<title>手作り差分チェック (CraftDiff) | DBFlute</title>
</head>
<body>
<div id="container" class="ct-manual">

<div id="mainbar">
<div id="header">
	<div class="navi-upper"><a href="../../../../../../ja/sitemap.html">SiteMap</a>|<a href="http://d.hatena.ne.jp/jflute/">Author's Blog</a></div>
	<div class="navi-main">
	<ul>
		<li class="hd-introduction"><a href="../../../../../../ja/introduction/index.html"><img src="../../../../../../image/parts/navi/link-intro.png" alt="Introduction" width="75" height="32" /></a></li>
		<li class="hd-tutorial"><a href="../../../../../../ja/tutorial/index.html"><img src="../../../../../../image/parts/navi/link-tuto.png" alt="Tutorial" width="56" height="24" /></a>
			<ul>
				<li class="hd-architect"><a href="../../../../../../ja/tutorial/architect.html"><img src="../../../../../../image/parts/navi/link-arch.png" alt="for Architect" width="80" height="24" /></a></li>
				<li class="hd-developer"><a href="../../../../../../ja/tutorial/developer.html"><img src="../../../../../../image/parts/navi/link-dev.png" alt="for Developer" width="87" height="24" /></a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../../../ja/environment/index.html"><img src="../../../../../../image/parts/navi/link-env.png" alt="Environment" width="84" height="25" /></a>
			<ul>
				<li class="hd-install"><a href="../../../../../../ja/environment/setup/index.html"><img src="../../../../../../image/parts/navi/link-setup.png" alt="Setup" width="42" height="24" /></a></li>
				<li class="hd-upgrade"><a href="../../../../../../ja/environment/upgrade/index.html"><img src="../../../../../../image/parts/navi/link-upgrade.png" alt="Upgrade" width="61" height="25" /></a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../../../ja/manual/index.html"><img src="../../../../../../image/parts/navi/link-manual.png" alt="Manual" width="62" height="25" /></a></li>
	</ul>
	</div>
</div>

<div id="content">
	<h1>手作り差分チェック</h1>
	<ul class="indexlist">
		<li><a href="#overview">概要</a></li>
		<li><a href="#howto">手作りのやり方</a>
			<ul>
				<li><a href="#preparesql">SQLファイルの用意</a></li>
				<li><a href="#dispdiff">差分結果の表示</a></li>
			</ul>
		</li>
		<li><a href="#immediatelyafter">SQLの追加や変更した直後</a></li>
		<li><a href="#checkenv">環境タイプごとの差分チェック</a></li>
		<li><a href="#schemameta">様々なスキーマの差分</a>
			<ul>
				<li><a href="#privilege">権限の差分チェック</a></li>
				<li><a href="#privilege">VIEWのSQLの差分チェック</a></li>
			</ul>
		</li>
		<li><a href="#example">Exampleのススメ</a></li>
	</ul>

	<h2 id="overview">概要</h2>
	<p>
		HistoryHTMLやSchemaSyncCheck, AlterCheckなどの差分ロジックにおいて、独自の差分チェックを手作りすることができます。
		<span class="freecomment">@since 1.0.0</span>
	</p>
	<p>
		DBFluteの差分ロジックは、テーブルやカラム、プロシージャ(オプションにて)などを対象にしますが、トリガーや権限などはチェック対象ではありません。
		そういったDBFluteのチェック対象外の要素を自由に追加することができます。また、マスタテーブルなどのデータもチェックできます。
	</p>
	<p>
		"差分チェック対象を検索するSQL" を書いて所定の位置に配置しておくと、差分チェック時に実行され、
		双方のスキーマの結果が比べられます。内部的には、検索結果がTSVファイルに出力され、そのTSVファイル同士が比較されます。
	</p>

	<h2 id="howto">手作りのやり方</h2>
	<h3 id="preparesql">SQLファイルの用意</h3>
	<p>
		craft-diff で始まり .sql で終わるファイルを、[DBFluteクライアント]/schema/craftdiff 配下に作成します。
		まずは、単に craft-diff.sql という名前のファイルでOKです。多くなってきたら分割していきます。
	</p>
	<p>
		そのSQLファイルの中で、差分チェック対象を検索するSQLを以下のルールに従って書きます。
	</p>
	<dl class="valuemainlist">
		<dt>SQLの種類</dt><dd>select文であること (結果セットを戻すSQL)</dd>
		<dt>ユニークキー</dt><dd>select句の最初のカラムはユニークな値のものを</dd>
		<dt>差分対象データ</dt><dd>select句の二番目以降に差分対象のカラムを</dd>
		<dt>おまじない</dt><dd>SQLの前に #df:assertEquals([差分タイトル名])# を</dd>
	</dl>
<pre><span class="codetitle">e.g. 会員ステータスのデータの差分をチェックするSQL @classificationDefinitionMap.dfprop</span><code>
<span class="comment">-- #df:assertEquals(MemberStatus)#</span>
<span class="keyword">select</span> MEMBER_STATUS_CODE, MEMBER_STATUS_NAME, DISPLAY_ORDER
  <span class="keyword">from</span> MEMBER_STATUS
;
</code></pre>
	<p>
		上記の例では、会員ステータスという区分値系のテーブルの変更を監視するようにしています。
		会員ステータスが追加されたり削除されたり、もしくはステータス名や表示順が変わったら差分として検知されます。
		ただ、DESCRIPTIONカラムは含まれていないので、説明の内容が変わっても検知はされません。
		あまり重要でないものを含めると差分ノイズになるので、バランス良くカラムを列挙しましょう。
	</p>
	<p>
		また、タイトル名には、そのSQLで検索されるデータを業務的に表現する適切な名前をつけましょう。
	</p>
	<h3 id="dispdiff">差分結果の表示</h3>
	<p>
		検知された差分は、HistoryHTMLなどの差分HTMLの中で、通常の差分と同じように表示されます。
	</p>
	<p class="imgbox">CraftDiffの例
		<a href="../../../../../data/model/doc-CraftDiff-example.png" title="CraftDiff Example"><img src="../../../../../data/model/doc-CraftDiff-example.png" alt="CraftDiff Example" width="550" height="220" /></a>
	</p>
	<p>
		この例では、HistoryHTML的な解釈をすると、会員ステータスに新しく "DIF" というステータスが追加されたということに加え、"FML"
		ステータスの情報に変更(表示順の変更)が入ったということがわかります。SchemaSyncCheck
		であれば、スキーマ間にこういった食い違いがある、ということになります。
	</p>
	<p>
		select句の一つ目のカラムが追加や変更を判別するキーとなり、二つ目以降のカラムは変更時の差分チェックの対象データとなります。
		チェック対象データのカラムが複数の場合は、単にパイプラインで連結された文字列として比較されるため、表示としてはどのカラムが変更になったのかはぱっと見でわからないこともあるかもしれませんが、
		"何かしらの差分があるということがわかりさえすれば"
		というポリシーでの割り切りです。<span class="freecomment">(ただし、天文学的な確率で同じハッシュ値になってしまうことはあり得ますが...)</span>
	</p>
	<p>
		また、チェック対象データに改行が含まれている場合は、プロシージャの差分チェックのときと同じように、ハッシュ値として比較され表示されます。
		これもまた、"何かが変わった" ということさえわかれば、あとはエクセルデータを見るなりDBを覗くなりいくらでも確認する方法があるという割り切りです。
	</p>
	<div class="relatedpage"><a href="../../../generator/task/doc/historyhtml.html#procedure">HistoryHTML - ストアドプロシージャの違い</a></div>
	<p>
		これらの差分チェックは、HistoryHTML, SchemaSyncCheck, AlterCheck
		などの差分ロジック全てに反映されます。SQLを書いて配置するだけで共通の差分ロジックとなります。
	</p>

	<h2 id="immediatelyafter">SQLの追加や変更した直後</h2>
	<p>
		HistoryHTMLのとき、差分チェックのSQLを追加した直後のDB変更では何も検知されません。
		一つの前のDBの状態における検索結果データがないため、比較ができないからです。
		その次のDB変更から差分チェックされるようになります。
	</p>
	<p>
		また、同じくHistoryHTMLにおいて、途中でSQLを変更した場合、例えば、差分チェック対象のカラムを追加した場合、
		それは差分として検知されてしまいます。気になる場合は、schema配下のdiffmapを直接修正して、差分を削除することもできます。
	</p>

	<h2 id="checkenv">環境タイプごとの差分チェック</h2>
	<p>
		DBFluteの環境タイプによって、差分チェックをするかしないかを調整できます。
		ReplaceSchemaのときと同じような感じでファイルの先頭に checkEnv([env-type])
		を指定することで、その環境タイプだけで実行されるSQLファイルとなります。
	</p>
	<div class="relatedpage"><a href="../../../../reference/dfprop/environmenttype.html#envvar">環境タイプごとの dfprop - 環境タイプの設定(環境変数)</a></div>
<pre><span class="codetitle">e.g. diffworldという環境タイプのときのみ差分をチェックするSQL @craft-diff.sql</span><code>
<span class="comment">-- #df:checkEnv(diffworld)#</span>

<span class="comment">-- #df:assertEquals(MemberStatus)#</span>
<span class="keyword">select</span> MEMBER_STATUS_CODE, MEMBER_STATUS_NAME, DISPLAY_ORDER
  <span class="keyword">from</span> MEMBER_STATUS
;

<span class="comment">-- #df:assertEquals(<span class="abbreviation">...</span>)#</span>
<span class="keyword">select</span> <span class="abbreviation">...</span>
  <span class="keyword">from</span> <span class="abbreviation">...</span>
;
<span class="abbreviation">...</span>
</code></pre>

	<h2 id="schemameta">様々なスキーマの差分</h2>
	<h3 id="privilege">権限の差分チェック</h3>
	<p>
		システムのテーブル(Oracleならデータディクショナリ)を検索することができれば、スキーマ内の "権限"
		も差分チェックすることができます。
	</p>
<pre><span class="codetitle">e.g. 権限を差分チェックするSQL (Oracle) @craft-diff.sql</span><code>
<span class="comment">-- #df:assertEquals(Dic_SystemPrivilege)#</span>
<span class="keyword">select</span> USERNAME || '.' || PRIVILEGE <span class="keyword">as</span> KEY, ADMIN_OPTION
  <span class="keyword">from</span> USER_SYS_PRIVS
 <span class="keyword">order by</span> KEY
;

<span class="comment">-- #df:assertEquals(Dic_TablePrivilege)#</span>
<span class="keyword">select</span> OWNER || '.' || TABLE_NAME || '(' || PRIVILEGE || ')' <span class="keyword">as</span> KEY, GRANTABLE, HIERARCHY
  <span class="keyword">from</span> USER_TAB_PRIVS
 <span class="keyword">order by</span> KEY
;
</code></pre>
	<h3 id="privilege">VIEWのSQLの差分チェック</h3>
	<p>
		VIEWは、デフォルトで自動生成対象なので select 句の構成に変更があれば普通のテーブルとして差分チェックされます。
		ただ、where句だけの変更とか、SQLの中身が変わっただけの変更は検知されません。それを CraftDiff
		で検知できるようにすることもできます。
	</p>
	<p>
		改行が含まれていること必至なので、差分結果はハッシュ値ですが、とにかく変わったということがわかれば、
		あとは、ReplaceSchemaのDDLを比べるとか、バージョン管理システムの差分を調べるとか、何かしらのアプローチで違いを把握することはできるはずです。
	</p>
<pre><span class="codetitle">e.g. VIEWのSQLを差分チェックするSQL (Oracle) @craft-diff.sql</span><code>
<span class="comment">-- #df:assertEquals(Dic_ViewSql)#</span>
<span class="keyword">select</span> VIEW_NAME <span class="keyword">as</span> KEY, TEXT_LENGTH, TEXT
  <span class="keyword">from</span> USER_VIEWS
 <span class="keyword">order by</span> KEY;
;
</code></pre>

	<h2 id="example">Exampleのススメ</h2>
	<p>
		dbflute-guice-example では、実際に CraftDiff を使って独自の差分をチェックしています。
		ぜひExampleを参考にしてみてください。
	</p>
	<div class="detailpage"><a href="../../../../reference/example/index.html#dicontainer">DBFlute Example - DIコンテナ</a></div>

</div>
</div>

<div id="sidebar">
	<div class="logo"><a href="../../../../../../"><img src="../../../../../../image/parts/logo.png" alt="dbflute-logo" width="240" height="110" /></a></div>
<ul>
		<li><a href="../../../../../../ja/manual/function/generator/index.html">自動生成ツール</a>
			<ul>
				<li><a href="../../../../../../ja/manual/function/generator/client/index.html">DBFluteクライアント</a></li>
				<li><a href="../../../../../../ja/manual/function/generator/module/index.html">DBFluteモジュール</a></li>
				<li><a href="../../../../../../ja/manual/function/generator/task/index.html">DBFluteタスク</a>
				<!-- 
					<ul>
						<li><a href="../../../../../../ja/manual/function/generator/task/jdbc/index.html">JDBC</a></li>
						<li><a href="../../../../../../ja/manual/function/generator/task/generate/index.html">Generate</a></li>
						<li><a href="../../../../../../ja/manual/function/generator/task/doc/index.html">Doc</a></li>
						<li><a href="../../../../../../ja/manual/function/generator/task/sql2entity/index.html">Sql2Entity</a></li>
						<li><a href="../../../../../../ja/manual/function/generator/task/outsidesqltest/index.html">OutsideSqlTest</a></li>
						<li><a href="../../../../../../ja/manual/function/generator/task/replaceschema/index.html">ReplaceSchema</a></li>
					</ul>
				 -->
				</li>
			</ul>
		</li>
		<li><a href="../../../../../../ja/manual/function/ormapper/index.html">O/Rマッパ</a>
			<ul>
				<li><a href="../../../../../../ja/manual/function/ormapper/behavior/index.html">Behavior</a></li>
				<li><a href="../../../../../../ja/manual/function/ormapper/conditionbean/index.html">ConditionBean</a></li>
				<li class="upper-space"><a href="../../../../../../ja/manual/function/ormapper/outsidesql/index.html">OutsideSql</a></li>
				<li><a href="../../../../../../ja/manual/function/ormapper/entity/index.html">Entity</a></li>
				<li><a href="../../../../../../ja/manual/function/ormapper/runtime/index.html">DBFluteランタイム</a></li>
			</ul>
		</li>
		<li>
			<a href="../../../../../../ja/manual/function/genbafit/index.html">現場フィット</a>
			<ul>
				<li><a href="../../../../../../ja/manual/function/genbafit/implfit/index.html">アプリ実装の全体最適</a></li>
				<li><a href="../../../../../../ja/manual/function/genbafit/projectfit/index.html">プロジェクト構成対応</a></li>
				<li class="upper-space"><a href="../../../../../../ja/manual/function/genbafit/runtimefit/index.html">実行時共通要件の実現</a></li>
				<li><a href="../../../../../../ja/manual/function/genbafit/deprecatedfit/index.html">非推奨な構造フォロー</a></li>
				<li><a href="../../../../../../ja/manual/function/genbafit/dbflutefit/index.html">DBFluteサポート</a></li>
			</ul>
		</li>
		<li><a href="../../../../../../ja/manual/function/helper/index.html">支援ツール</a>
			<ul>
				<li><a href="../../../../../../ja/manual/function/helper/emecha/index.html">EMecha(Eclipse Plugin)</a></li>
				<li><a href="../../../../../../ja/manual/function/helper/maven/index.html">Maven DBFlute Plugin</a></li>
			</ul>
		</li>
		<li><a href="../../../../../../ja/manual/reference/index.html">リファレンス</a>
			<ul>
				<li><a href="../../../../../../ja/manual/reference/dbway/index.html">DBMSごとの取扱い</a></li>
				<li><a href="../../../../../../ja/manual/reference/diway/index.html">DIコンテナごとの取扱い</a></li>
				<li class="upper-space"><a href="../../../../../../ja/manual/reference/dfprop/index.html">DBFluteプロパティ</a></li>
				<li><a href="../../../../../../ja/manual/reference/dictionary/index.html">DBFlute用語集</a></li>
				<li><a href="../../../../../../ja/manual/reference/example/index.html">DBFlute Example</a></li>
				<li class="upper-space"><a href="../../../../../../ja/manual/reference/faq/index.html">FAQ</a></li>
				<li><a href="../../../../../../ja/manual/reference/troubleshooting/index.html">トラブルシューティング</a></li>
			</ul>
		</li>
		<li><a href="../../../../../../ja/manual/topic/index.html">トピック</a>
			<ul>
				<li><a href="../../../../../../ja/manual/topic/dbdesign/index.html">DB設計</a></li>
				<li><a href="../../../../../../ja/manual/topic/programming/index.html">プログラミング</a></li>
				<li><a href="../../../../../../ja/manual/topic/friends/index.html">他のフレームワーク</a></li>
				<li class="upper-space"><a href="../../../../../../ja/manual/topic/office/index.html">事務的な話</a></li>
				<li><a href="../../../../../../ja/manual/topic/dbflutenet/index.html">DBFlute.NET</a></li>
			</ul>
		</li>
	</ul>

</div>

<div id="footer">
	<div><a href="../../../../../../ja/sitemap.html">SiteMap</a> <a href="http://d.hatena.ne.jp/jflute">Author's Blog</a><a href="https://www.seasar.org/issues/browse/DBFLUTE">BTS</a></div>
	<ul class="footer-navi">
		<li class="hd-introduction"><a href="../../../../../../ja/introduction/index.html">Introduction</a></li>
		<li class="hd-tutorial"><a href="../../../../../../ja/tutorial/index.html">Tutorial</a>
			<ul>
				<li class="hd-architect"><a href="../../../../../../ja/tutorial/architect.html">for Architect</a></li>
				<li class="hd-developer"><a href="../../../../../../ja/tutorial/developer.html">for Developer</a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../../../ja/environment/index.html">Environment</a>
			<ul>
				<li class="hd-install"><a href="../../../../../../ja/environment/setup/index.html">Setup</a></li>
				<li class="hd-upgrade"><a href="../../../../../../ja/environment/upgrade/index.html">Upgrade</a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../../../ja/manual/index.html">Manual</a></li>
	</ul>

</div>

</div>
</body>
</html>
