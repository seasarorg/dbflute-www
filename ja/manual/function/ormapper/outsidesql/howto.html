<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta name="keywords" content="DBFlute,外だしSQL,OutsideSql,使い方,利用方法,実装方法,実装手順" />
	<link rel="stylesheet" type="text/css" href="../../../../../css/sub.css" />
	<!--[if IE 6.0]>
		<link rel="stylesheet" type="text/css" href="../../../../../css/cb/sub.css" />
	<![endif]--> 
	<title>外だしSQLの使い方 | DBFlute</title>
</head>
<body>
<div id="container" class="ct-manual">

<div id="mainbar">
<div id="header">
	<div class="navi-upper"><a href="../../../../../ja/sitemap.html">SiteMap</a>|<a href="http://d.hatena.ne.jp/jflute/">Author's Blog</a></div>
	<div class="navi-main">
	<ul>
		<li class="hd-introduction"><a href="../../../../../ja/introduction/index.html"><img src="../../../../../image/parts/navi/link-intro.png" alt="Introduction" width="75" height="32" /></a></li>
		<li class="hd-tutorial"><a href="../../../../../ja/tutorial/index.html"><img src="../../../../../image/parts/navi/link-tuto.png" alt="Tutorial" width="56" height="24" /></a>
			<ul>
				<li class="hd-architect"><a href="../../../../../ja/tutorial/architect.html"><img src="../../../../../image/parts/navi/link-arch.png" alt="for Architect" width="80" height="24" /></a></li>
				<li class="hd-developer"><a href="../../../../../ja/tutorial/developer.html"><img src="../../../../../image/parts/navi/link-dev.png" alt="for Developer" width="87" height="24" /></a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../../ja/environment/index.html"><img src="../../../../../image/parts/navi/link-env.png" alt="Environment" width="84" height="25" /></a>
			<ul>
				<li class="hd-install"><a href="../../../../../ja/environment/setup/index.html"><img src="../../../../../image/parts/navi/link-setup.png" alt="Setup" width="42" height="24" /></a></li>
				<li class="hd-upgrade"><a href="../../../../../ja/environment/upgrade/index.html"><img src="../../../../../image/parts/navi/link-upgrade.png" alt="Upgrade" width="61" height="25" /></a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../../ja/manual/index.html"><img src="../../../../../image/parts/navi/link-manual.png" alt="Manual" width="62" height="25" /></a></li>
	</ul>
	</div>
</div>

<div id="content">
	<h1>外だしSQLの使い方</h1>
	<ul class="indexlist">
		<li><a href="#implflow">実装の流れ</a></li>
		<li><a href="#concept">実装概念</a>
			<ul>
				<li><a href="#tabledriven">テーブル駆動でSQLを管理</a></li>
				<li><a href="#separatedlogic">呼び出しロジックとSQLの固定仕様の分離</a></li>
				<li><a href="#typedandfree">タイプセーフ、そして、自由度考慮</a></li>
			</ul>
		</li>
		<li><a href="#sqlfile">1. SQLファイルを作成する</a>
			<ul>
				<li><a href="#basepointtable">基点となるテーブル</a></li>
				<li><a href="#sqlfileencoding">エンコーディング</a></li>
				<li><a href="#wrongbhv">存在しないBehaviorを指定すると</a></li>
			</ul>
		</li>
		<li><a href="#twowaysql">2. SQLを2Way-SQLで実装する</a>
			<ul>
				<li><a href="#customizeentitymark">CustomizeEntity マーク</a></li>
				<li><a href="#parameterbeanmark">ParameterBean マーク</a></li>
				<li><a href="#sqltitledesc">SQLのタイトルや説明</a></li>
			</ul>
		</li>
		<li><a href="#sql2entity">3. Sql2Entity を実行する</a>
			<ul>
				<li><a href="#wrongsql">SQLが文法的に間違っている場合</a></li>
			</ul>
		</li>
		<li><a href="#outsidesql">4. 外だしSQLを呼び出す</a>
			<ul>
				<li><a href="#log">外だしSQLの実行ログ</a></li>
			</ul>
		</li>
		<li><a href="#bhvinstance">Behaviorインスタンスの取得</a></li>
		<li><a href="#freestylebasic">フリースタイル基本仕様</a>
			<ul>
				<li><a href="#sqlpath">SQLのパス (path)</a></li>
				<li><a href="#pmb">ParameterBean (pmb)</a></li>
				<li><a href="#cmentity">CustomizeEntity (entityType)</a></li>
			</ul>
		</li>
		<li><a href="#completion">コード補完を駆使して実装</a>
			<ul>
				<li><a href="#firstchar">先頭文字を覚えておくのが大事</a></li>
				<li><a href="#autoresult">戻り値の抽出</a></li>
			</ul>
		</li>
	</ul>

	<h2>外だしSQLの基本</h2>
	<p>
		そもそも外だしSQLとは？について説明するページがあります。
	</p>
	<div class="detailpage"><a href="./about.html">外だしSQLについて</a></div>

	<h2 id="implflow">実装の流れ</h2>
	<p>
		実装の流れは以下のようになります。
	</p>
	<ul class="flowlist">
		<li><a href="#concept">0. (DBFluteの外だしSQL実装の概念を学ぶ)</a></li>
		<li><a href="#sqlfile">1. SQLファイルを作成する</a></li>
		<li><a href="#twowaysql">2. SQLを 2Way-SQL で実装する</a></li>
		<li><a href="#sql2entity">3. Sql2Entity を実行する</a></li>
		<li><a href="#outsidesql">4. 外だしSQLを呼び出す</a></li>
	</ul>
	<p>
		ここでは、EMecha を利用しないプリミティブなやり方を紹介します。実際の開発では、EMechaの <em class="keyword">EMSql</em>
		の機能を利用して、<em class="keyword">SQLファイルの作成</em> と <em class="keyword">Sql2Entityマーク</em>
		の記述をウィザード画面から指定できる安全なやり方をお奨めします。
	</p>
	<div class="detailpage"><a href="../../helper/emecha/emsql/index.html#newoutsidesql">EMecha - EMSql - SQLファイルの作成</a></div>

	<h2 id="concept">実装概念</h2>
	<h3 id="tabledriven">テーブル駆動でSQLを管理</h3>
	<p>
		ConditionBean がそうであるように、外だしSQLも "基点テーブル"
		という概念を重視します。SQLファイルの名前は <em class="keyword">[Behaviorクラス名]_[SQL名(SQLを表現する任意の名前)].sql</em>
		という形式にすることを推奨しています(デフォルトでは exbhv
		パッケージ配下)。たとえ基点テーブルが曖昧なSQLにおいても、管理上どれかのテーブルと関連付けるようにします。
		これを <em class="keyword">BehaviorQuery</em> (形式) と呼びます。
	</p>
<pre><span class="codetitle">ex) BehaviorQuery を使ったSQLファイルの管理 {src/main/resources} @Directory</span><code>
foo-project
 |-src/main/resources
       |-com<span class="abbreviation">...</span>/dbflute
             |-exbhv
               |-<span class="point">MemberBhv_selectSimpleMember.sql</span>
</code></pre>
	<p>
		SQL名は、select文なら "select..."、update文なら "update..." と、小文字始まりでSQLを prefix
		でわかりやすく表現することが推奨されます。この prefix を除去した残りの部分の名前を <em class="keyword">SQL業務名</em>
		と呼び、アプリ全体でユニークなアプリ固有の業務上の名前を付けます。	(ただし、先頭文字が大文字の場合は、何も除去せずSQL名そのままがSQL業務名となります)
	</p>
	<p>
		このSQLファイルへのパスは Sql2Entity タスクで分析され、プログラム上では Behavior
		とSQL業務名(自動生成されたクラス、ParameterBean)だけで呼び出すことができるようになります。
	</p>
<pre><span class="codetitle">ex) テーブル駆動でSQLを呼び出す @Java</span><code>
SimpleMemberPmb pmb = <span class="keyword">new</span> SimpleMemberPmb(); <span class="comment">// SQL業務名 + Pmb</span>
pmb.setMemberName_PrefixSearch(<span class="literal">"S"</span>);

<span class="comment">// 外だしSQLの実行 (MemberBhv_selectSimpleMember.sql)</span>
<span class="comment">// 対応する Behavior で呼び出し</span>
List&lt;SimpleMember&gt; memberList
        = <span class="point">memberBhv</span>.outsideSql().selectList(pmb);
</code></pre>
	<p>
		SQL業務名にどうのような名前を付けるか？
		これは業務の特徴次第なのでフレームワークとして明確な定義はできませんが、例えば DBFlute の Example
		では以下のような命名をしています。(参考までに)
	</p>
	<dl class="textlist">
		<dt>検索系</dt>
		<dd>検索対象の業務的概要 + 基点テーブルの抽象名</dd>
		<dd>
			e.g. UnpaidSummaryMember (未払い購入情報付き会員)
			<span class="freecomment">MemberBhv_selectUnpaidSummaryMember.sql</span>
		</dd>
		<dt>更新系</dt>
		<dd>更新対象テーブルの抽象名 + 更新内容の業務的概要(受動態)</dd>
		<dd>
			e.g. MemberChangedToWithdrawalForcedly (会員の強制退会)
			<span class="freecomment">MemberBhv_updateMemberChangedToWithdrawalForcedly.sql</span>
		</dd>
	</dl>
	<h3 id="separatedlogic">呼び出しロジックとSQLの固定仕様の分離</h3>
	<p>
		DBFluteでは、呼び出しロジックとSQLの固定仕様を分離したインターフェースを提供しています。
	</p>
	<p>
		呼び出しロジックは、例えば、結果をリスト型で受け取るのか、Entity(一件) 型で受け取るのか、ページング形式で受け取るのか、その他細かいオプション(StatementConfig
		など)をどのように指定するのか、こういったものを指します。これらは、一つのSQLに対し複数の実装が存在することが想定されます。
		それに対しSQLの固定仕様というのは、例えば、バインドパラメータの構成、戻り値の型など、一つのSQLで基本的に一つの決まるものです。
	</p>
	<p>
		プログラム上での呼び出しにおいて、この考え方がそのまま反映されています。
	</p>
<pre><span class="codetitle">ex) 呼び出しロジックとSQLの仕様の分離 (リスト) @Java</span><code>
<span class="comment">// リスト型での呼び出し</span>
SimpleMemberPmb pmb = <span class="keyword">new</span> SimpleMemberPmb(); <span class="comment">// SQLの固定仕様</span>
pmb.setMemberName_PrefixSearch(<span class="literal">"S"</span>); <span class="comment">// バインドパラメータ</span>

<span class="comment">// 外だしSQLの実行 (MemberBhv_selectSimpleMember.sql)</span>
<span class="comment">// o 結果をリスト型で受け取る -&gt; 呼び出しロジック</span>
<span class="comment">// o Entityの型は SimpleMemberクラス -&gt; SQLの固定仕様</span>
List&lt;<span class="point">SimpleMember</span>&gt; memberList
        = <span class="attribute">memberBhv</span>.outsideSql().<span class="point">selectList</span>(pmb);
</code></pre>
<pre><span class="codetitle">ex) 呼び出しロジックとSQLの仕様の分離 (Entity) @Java</span><code>
SimpleMemberPmb pmb = <span class="keyword">new</span> SimpleMemberPmb(); <span class="comment">// SQLの固定仕様</span>
pmb.setMemberId(<span class="literal">3</span>); <span class="comment">// バインドパラメータ (PK値の指定)</span>

<span class="comment">// 外だしSQLの実行 (MemberBhv_selectSimpleMember.sql)</span>
<span class="comment">// o 結果を Entity(一件) 型で受け取る -&gt; 呼び出しロジック</span>
<span class="comment">// o Entityの型は SimpleMemberクラス -&gt; SQLの固定仕様</span>
<span class="point">SimpleMember</span> member
        = <span class="attribute">memberBhv</span>.outsideSql().entityHandling().<span class="point">selectEntity</span>(pmb);
</code></pre>
	<p>
		ConditionBean のことを思い出すと、条件は ConditionBean で呼び出しロジックは
		Behavior。つまり、DBFlute 全体でこのようなポリシーになっていることがわかります。
	</p>
	<h3 id="typedandfree">タイプセーフ、そして、自由度考慮</h3>
	<p>
		"外部のSQLを呼び出す" という場合、一般に指定すべき基本的な要素は以下の三つです。
	</p>
	<ul>
		<li>SQLへのパス</li>
		<li>SQLに渡すパラメータ(バインド変数の値など)</li>
		<li>戻り値　Entity の型 (検索時)</li>
	</ul>
	<p>
		DBFluteでは、"SQLに渡すパラメータ" を格納する DTO を ParameterBean、"戻り値を受け取る型" に対応する Entity
		クラスを CustomizeEntity と呼びます。また、BehaviorQuery としてのSQLへのパスを BehaviorQueryPath と呼びます。
	</p>
	<h4 id="typedpmb">TypedParameterBean</h4>
	<p>
		これらはSQLの固定仕様であり、それぞれ基本的に 1:1:1 です。DBFluteでは、Sql2Entity
		タスクにより、これらの要素が全て関連付いた ParameterBean を自動生成します。これをSQLファイルに型付けされた ParameterBean
		ということで TypedParameterBean (たいぷどぱらめーたびーん)
		と呼び、SQLの特定や戻り値 Entity の型の解決を一括した "定型呼び出し" を提供します<span class="freecomment">(@since 0.9.8.0)</span>。
	</p>
<pre><span class="codetitle">ex) TypedParameterBean による呼び出し @Java</span><code>
SimpleMemberPmb pmb = <span class="keyword">new</span> SimpleMemberPmb(); <span class="comment">// TypedParameterBean</span>
pmb.setMemberName_PrefixSearch(<span class="literal">"S"</span>);

<span class="comment">// 外だしSQLの実行 (MemberBhv_selectSimpleMember.sql)</span>
<span class="comment">// 何を呼び出すか？ 何の Entity 型で受け取るか？ は SimpleMemberPmb が解決</span>
List&lt;SimpleMember&gt; memberList
        = <span class="attribute">memberBhv</span>.outsideSql().selectList(<span class="point">pmb</span>);
</code></pre>
	<p>
		ParameterBean の引数は、Sql2Entity タスクで自動付与されるそれぞれの呼び出しロジックに対応したインターフェースです。例えば、selectList()
		なら ListHandlingPmb、selectCursor() なら CursorHandlingPmb
		など。パスや戻り値Entityの型の解決にも利用されるためパラメータがなくてもParameterBeanは必要です(つまり、null は許容されない)。
	</p>
	<p>
		さらには、対応する Behavior
		への型付け、リストやページング、カーソルなど、そのSQLが実行可能な呼び出しロジックの型付けもされ、間違った呼び出しはコンパイル時にチェックされます。
		例えば、PurchaseBhv に関連付けられている SQL を MemberBhv で呼び出すことはできません。
		また、ページングを前提としたSQLに対して、単なるリスト型の検索や、カーソル検索などの間違った呼び出しをすることはできません。
	</p>
	<p>
		TypedParameterBean として型付けされる条件は、それぞれの呼び出しロジックごとにあります。その ParameterBean
		がどのように型付けされたのかは、Bsクラスが実装しているインターフェースでもわかりますが、ParameterBean
		のクラスコメント(javadoc)にわかりやすく書かれています。Eclipse 上で ParameterBean
		にカーソルを合わせてふんわり出てくるクラスコメントを参考にすると良いでしょう。
	</p>
	<div class="relatedpage"><a href="./select/selectlist.html">selectList()</a></div>
	<div class="relatedpage"><a href="./select/selectentity.html">entityHandling() - selectEntity()</a></div>
	<div class="relatedpage"><a href="./select/selectpagemanual.html">manualPaging() - selectPage()</a></div>
	<div class="relatedpage"><a href="./select/selectpageauto.html">autoPaging() - selectPage()</a></div>
	<div class="relatedpage"><a href="./select/selectcursor.html">cursorHandling() - selectCursor()</a></div>
	<p>
		ConditionBean はテーブルごとの CB、外だしSQLはSQLごとの TypedParameterBean、プロシージャはプロシージャごとの
		ProcedurePmb、つまり、DBFlute全体で "対応する Bean" を基点にDBアクセスが始まっていると言えます。
	</p>
	<h4 id="freestyle">フリースタイル形式のメソッド</h4>
	<p>
		ほとんどの外だしSQLは、この TypedParameterBean の形式で実行されることが想定されます。
		ただし、場合によっては 1:1:1 とならないような利用方法も想定されます。例えば、ParameterBean
		を別のSQLでも再利用したり、戻り値Entityの型は既に存在する別のクラスを使ったり、など。
		そういった場合のために、この三つの要素をバラバラに指定するフリースタイル形式の自由度考慮のメソッドも用意されています。
	</p>
<pre><span class="codetitle">ex) フリースタイル形式の自由度考慮のメソッドによる呼び出し @Java</span><code>
String path = MemberBhv.PATH_selectSimpleMember; <span class="comment">// BehaviorQueryPath (自動生成)</span>
<span class="point">SimpleMemberPmb</span> pmb = <span class="keyword">new</span> SimpleMemberPmb(); <span class="comment">// ParameterBean</span>
pmb.setMemberName_PrefixSearch(<span class="literal">"S"</span>);
Class&lt;SimpleMember&gt; entityType = SimpleMember.class

<span class="comment">// 外だしSQLの実行 (MemberBhv_selectSimpleMember.sql)</span>
<span class="comment">// 何を呼び出すか？ 何の Entity 型で受け取るか？ は SimpleMemberPmb が解決</span>
List&lt;SimpleMember&gt; memberList
        = <span class="attribute">memberBhv</span>.outsideSql().selectList(path, pmb, entityType);
</code></pre>
	<p>
		ParameterBean 引数は、単なる Object 型であり何でも受け入れます。パラメータがない場合は null
		も許容されます。TypedParameterBean を指定したとしても、内部ロジックで評価されるのはパラメータ部分の要素だけです。
	</p>
	<div class="inucolumn">
		<h4 id="migration">0.9.8.0 より前はフリースタイルのみ</h4>
		<p>
			TypedParameterBean の概念は、DBFlute-0.9.8.0
			から導入されたものであり、それより前のバージョンではフリースタイル形式のみでの実行となります。
		</p>
		<p>
			ただ、フリースタイル形式であっても、BehaviorQuery であれば "SQLのパス"
			は自動生成されるため、呼び出し対象SQLの指定がタイプセーフであることに変わりはありません。
			TypedParameterBean の導入で、お決まりパターン(三要素が 1:1:1
			になるケース)の呼び出しに対して、お決まりのレールを整備したと言えます。(実装のすっきりさ、そして、組み合わせの間違い防止など)
		</p>
	</div>

	<h2 id="sqlfile">1. SQLファイルを作成する</h2>
	<p>
		外だしSQLが初めての方は、先に DBFlute の "外だしSQLの実装概念"
		を理解するようにして下さい。(ここでは TypedParameterBean を前提とした手順となります)
	</p>
	<div class="detailpage"><a href="#concept">this - 実装概念</a></div>
	<p>
		Sql2Entityタスクで参照されるディレクトリの exbhv パッケージ配下に
		<em class="keyword">[Behaviorクラス名]_[SQL名(SQLを表現する任意の名前)].sql</em>
		という形式の名前でSQLファイルを作成します。
	</p>
	<div class="detailpage"><a href="../../generator/task/sql2entity/index.html#refsql">Sql2Entity - 外だしSQLを参照</a></div>
<pre><span class="codetitle">ex) SQLファイルの配置パッケージ(ディレクトリ) {src/main/resources} @Directory</span><code>
foo-project
 |-dbflute_foo
   |-dfprop
   |-<span class="abbreviation">...</span>
 |-src
   |-main
     |-resources
       |-com
         |-<span class="abbreviation">...</span>
           |-dbflute
             |-exbhv
               |-<span class="point">MemberBhv_selectSimpleMember.sql</span>
</code></pre>
	<h3 id="basepointtable">基点となるテーブル</h3>
	<p>
		Behaviorは、<em class="keyword">その外だしSQLの中で業務的に基点となるテーブル</em>
		に対応するものを選びます。但し、これは業務的な関連付けなので、厳密でなくても動作自体には支障はありません。
	</p>
	<div class="relatedpage"><a href="#tabledriven">this - テーブル駆動でSQLを管理</a></div>
	<h3 id="sqlfileencoding">エンコーディング</h3>
	<p>
		outsideSqlDefinitionMap.dfprop の <em class="keyword">sqlFileEncoding</em>
		で指定されたエンコーディングで作成する必要があります。
	</p>
	<div class="relatedpage"><a href="../../../reference/dfprop/outsidesqldefinition/index.html#sqlfileencoding">dfprop - sqlFileEncoding</a></div>
	<h3 id="wrongbhv">存在しないBehaviorを指定すると</h3>
	<p>
		存在しないBehaviorを指定すると、Sql2Entityで明示的な例外が発生します。
		テーブル名の変更などで利用していたBehaviorが削除された場合は、Sql2Entityを実行することで検知して修正します。
	</p>

	<h2 id="twowaysql">2. SQLを2Way-SQLで実装する</h2>
	<p>
		作成したSQLファイルの中で、SQLを <em class="keyword">2Way-SQL</em> として実装します。
	</p>
<pre><span class="codetitle">ex) 2Way-SQLでの実装 (CustomizeEntity と ParameterBean を利用) @OutsideSql</span><code>
<span class="comment">-- #df:entity#</span>

<span class="comment">-- !df:pmb!</span>
<span class="comment">-- !!Integer memberId!!</span>
<span class="comment">-- !!String memberName:likePrefix!!</span>

<span class="keyword">select</span> member.MEMBER_ID
     , member.MEMBER_NAME
     , memberStatus.MEMBER_STATUS_NAME
  <span class="keyword">from</span> MEMBER member
    <span class="keyword">left outer join</span> MEMBER_STATUS memberStatus
      <span class="keyword">on</span> member.MEMBER_STATUS_CODE = memberStatus.MEMBER_STATUS_CODE
 <span class="comment">/*BEGIN*/</span><span class="keyword">where</span>
   <span class="comment">/*IF pmb.memberId != null*/</span>
   member.MEMBER_ID = <span class="comment">/*pmb.memberId*/</span><span class="literal">3</span>
   <span class="comment">/*END*/</span>
   <span class="comment">/*IF pmb.memberName != null*/</span>
   <span class="keyword">and</span> member.MEMBER_NAME like <span class="comment">/*pmb.memberName*/</span><span class="literal">'M%'</span>
   <span class="comment">/*END*/</span>
 <span class="comment">/*END*/</span>
 <span class="keyword">order by</span> member.BIRTHDATE <span class="keyword">desc</span>, member.MEMBER_ID <span class="keyword">asc</span>
</code></pre>
	<p>
		ポイントは以下の通りです。
	</p>
	<dl class="textlist">
		<dt>A. Sql2Entityマーク</dt>
		<dd>
			CustomizeEntity (検索時) と ParameterBean の宣言を行う。
			<div class="detailpage"><a href="../../generator/task/sql2entity/index.html#sql2entitymark">Sql2Entityマーク</a></div>
		</dd>
		<dt>B. パラメータコメント</dt>
		<dd>
			ParameterBeanへの参照は pmb という変数名を利用すること。
			<div class="detailpage"><a href="./pmcomment.html">パラメータコメント</a></div>
		</dd>
	</dl>
	<h3 id="customizeentitymark">CustomizeEntity マーク</h3>
	<p>
		CustomizeEntity マークを宣言することで、SQLに対応する Entity (CustomizeEntity)
		が自動生成されます。検索系で TypedParameterBean を利用する場合は必須です。
	</p>
	<div class="detailpage"><a href="../../generator/task/sql2entity/customizeentity.html#customizeentitymark">CustomizeEntityマーク</a></div>
<pre><span class="codetitle">ex) CustomizeEntityマークの宣言 @OutsideSql</span><code>
<span class="comment">-- #df:entity#</span>
</code></pre>
	<p>
		カーソル検索の場合は、CustomizeEntity マークに加えて TypeSafeCursor マーク (cursor オプション) を付与することで、TypeSafeCursor
		が自動生成されます。カラムが一つだけの場合でも、カーソル検索の場合は必ずこの宣言を行います。
	</p>
	<div class="detailpage"><a href="../../generator/task/sql2entity/typesafecursor.html#typesafecursormark">TypeSafeCursorマーク</a></div>
<pre><span class="codetitle">ex) TypeSafeCursorマークの宣言 @OutsideSql</span><code>
<span class="comment">-- #df:entity#</span>
<span class="comment">-- +cursor+</span>
</code></pre>
	<p>
		カラムが一つだけの場合(かつ、カーソル検索ではない場合)で、Entity ではなくスカラ値(Integer や String
		など)として取得する場合は、CustomizeEntity マークに加えて scalar
		オプションを付けます<span class="freecomment">(@since 0.9.8.0)</span>。この場合、Entity
		は生成されずカラムの型(だけ)が戻り値の型として TypedParameterBean に関連付けられます。
	</p>
<pre><span class="codetitle">ex) CustomizeEntityマークの宣言 @OutsideSql</span><code>
<span class="comment">-- #df:entity#</span>
<span class="comment">-- +scalar+</span>
<span class="abbreviation">...</span>
select max(BIRTHDATE) from <span class="abbreviation">...</span>
</code></pre>
	<h3 id="parameterbeanmark">ParameterBean マーク</h3>
	<p>
		ParameterBean マークを宣言することで、SQLへ渡すパラメータが格納できる ParameterBean
		が自動生成されます。また、TypedParameterBean であれば対応するSQLへのパスや Entity
		の型なども関連付けられ、プログラム上での呼び出しにおける基点クラスとなります。
		ゆえに TypedParameterBean の場合はこの宣言は必須です。
	</p>
	<div class="detailpage"><a href="../../generator/task/sql2entity/parameterbean.html#parameterbeanmark">ParameterBeanマーク</a></div>
<pre><span class="codetitle">ex) ParameterBeanマークの宣言 @OutsideSql</span><code>
<span class="comment">-- !df:pmb!</span>
<span class="comment">-- !!Integer memberId!!</span>
<span class="abbreviation">...</span>
</code></pre>
<pre><span class="codetitle">ex) スカラ値のParameterBean利用時のパラメータコメント @OutsideSql</span><code>
<span class="comment">MEMBER_ID = /*pmb*/3</span>
</code></pre>
	<h3 id="sqltitledesc">SQLのタイトルや説明</h3>
	<p>
		必須ではありませんが、<em class="keyword">そのSQLを業務的に表すタイトルと説明</em>
		をSQLファイルに付与しておくことをお奨めします。それらは、単なるSQLファイル上のコメントとしてだけでなく、<em class="keyword">JavaDocやSchemaHTMLでも参照できる重要なコメント</em>
		となります。
	</p>
	<div class="relatedpage"><span class="working"><!-- <a href="./genbafit/outsidesqltitle/index.html"> -->(外だしSQL)現場フィット - 外だしSQLのタイトル<!-- </a> --></span></div>
	<div class="relatedpage"><span class="working"><!-- <a href="./genbafit/outsidesqldescription/index.html"> -->(外だしSQL)現場フィット - 外だしSQLの説明<!-- </a> --></span></div>
	<div class="relatedpage"><a href="../../generator/task/doc/schemahtml.html#outsidesql">SchemaHTML - 外だしSQL一覧</a></div>
	<p>
		SQLファイルの先頭の <em class="keyword">/* ... */</em> 形式のコメントの中で、<em class="keyword">[df:title]</em>
		の直後にSQLのタイトル、<em class="keyword">[df:description]</em> の直後にSQLの説明を記述します。
	</p>
<pre><span class="codetitle">ex) SQLのタイトルと説明を記述 @OutsideSql</span><code>
<span class="comment">/*</span>
 <span class="point">[df:title]</span>
 <span class="comment">シンプルな会員検索のExample</span>
 
 <span class="point">[df:description]</span>
 <span class="comment">このSQLはOutsideSqlの最も基本的なExampleです。
 参考ポイント：
   o パラメータコメント(IFコメントやバインド変数コメントなど)の利用方法
   o Sql2Entityで生成するCustomizeEntityとParameterBeanの定義方法
   o 外だしSQLの業務的なタイトル・説明(SchemaHTMLにて表示される)の記述方法
 外だしSQLのエンコーディングはデフォルトで「UTF-8」です。
 ダブルバイト文字を利用する場合はエディタのエンコーディングにご注意下さい。
 補足：
   o この外だしSQLと同じSQLはConditionBeanで実現可能
*/</span>
<span class="comment">-- #df:entity#</span>
<span class="abbreviation">...</span>
<span class="keyword">select</span> <span class="abbreviation">...</span>
</code></pre>
	<p>
		例えば、このタイトルと説明をアプリケーション全体で必須にしたいというときは、outsideSqlDefinitionMap.dfprop
		の設定で <em class="keyword">OutsideSqlTestタスクで必須チェック</em> を掛けることができます。
	</p>
	<div class="relatedpage"><a href="../../generator/task/outsidesqltest/index.html#checksqltitle">OutsideSqlTest - 外だしSQLのタイトル (オプション)</a></div>
	<div class="relatedpage"><a href="../../generator/task/outsidesqltest/index.html#checksqldesc">OutsideSqlTest - 外だしSQLの説明 (オプション)</a></div>

	<h2 id="sql2entity">3. Sql2Entity を実行する</h2>
	<p>
		<em class="keyword">Sql2Entityタスク</em> を実行します。
	</p>
	<div class="detailpage"><a href="../../generator/task/sql2entity/index.html">DBFluteタスク - Sql2Entityタスク</a></div>
	<p>
		ParameterBean (TypedParameterBean) や CustomizeEntity が自動生成されます。
	</p>
	<h3 id="wrongsql">SQLが文法的に間違っている場合</h3>
	<p>
		Sql2Entity実行時に例外が発生します。SQL文を修正して成功するまで再実行して下さい。
	</p>

	<h2 id="outsidesql">4. 外だしSQLを呼び出す</h2>
	<p>
		対応する Behavior の <em class="keyword">outsideSql()</em> メソッドを利用して該当のSQLを実行します。 
	</p>
	<div class="relatedpage"><a href="#bhvinstance">this - Behaviorインスタンスの取得</a></div>
	<p>
		outsideSql() に続いて、リスト検索、カーソル検索、更新処理など、様々なメソッドが用意されています。
		TypedParameterBean であれば、パラメータを設定した ParameterBean
		を指定するだけで呼び出すことができます<span class="freecomment">(@since 0.9.8.0)</span>。
		(また、利用できるメソッドが既に型付けされていて、間違ったメソッドで呼び出してもコンパイルエラーとして検知できます)
	</p>
<pre><span class="codetitle">ex) リスト検索 (TypedParameterBean) {名前が 'S' で始まる会員を検索｝@Java</span><code>
SimpleMemberPmb pmb = <span class="keyword">new</span> SimpleMemberPmb();
pmb.setMemberName_PrefixSearch(<span class="literal">"S"</span>);

<span class="comment">// 外だしSQLの実行 (MemberBhv_selectSimpleMember.sql)</span>
List&lt;SimpleMember&gt; memberList
        = <span class="attribute">memberBhv</span>.outsideSql().selectList(pmb);
</code></pre>
	<p>
		その他詳しい仕様はメソッドごとの詳細ページにて。
	</p>
	<div class="relatedpage"><a href="./select/selectlist.html">selectList()</a></div>
	<div class="relatedpage"><a href="./select/selectentity.html">entityHandling() - selectEntity()</a></div>
	<div class="relatedpage"><a href="./select/selectpagemanual.html">manualPaging() - selectPage()</a></div>
	<div class="relatedpage"><a href="./select/selectpageauto.html">autoPaging() - selectPage()</a></div>
	<div class="relatedpage"><a href="./select/selectcursor.html">cursorHandling() - selectCursor()</a></div>
	<p>
		一方、ParameterBean が宣言されている SQL 以外の SQL を呼び出したり(つまり、別のSQLで ParameterBean
		を再利用)、CustomizeEntity を利用せずに独自のクラスを戻り値の型にしたりなど、パスやパラメータ、戻り値の型がバラバラに連携するような場合は、
		それぞれの要素を個別に指定して呼び出します(フリースタイル形式)。
	</p>
<pre><span class="codetitle">ex) リスト検索 (フリースタイル形式) {名前が 'S' で始まる会員を検索｝@Java</span><code>
<span class="comment">// SQLのパス: BehaviorQueryPath</span>
String path = MemberBhv.<span class="attribute">PATH_selectSimpleMember</span>;

<span class="comment">// パラメータ: ParameterBean</span>
SimpleMemberPmb pmb = <span class="keyword">new</span> SimpleMemberPmb();
pmb.setMemberName_PrefixSearch(<span class="literal">"S"</span>);

<span class="comment">// 戻り値Entityの型: CustomizeEntity</span>
Class&lt;SimpleMember&gt; entityType = SimpleMember.<span class="keyword">class</span>;

<span class="comment">// 外だしSQLの実行 (指定された path に対応するSQL)</span>
List&lt;SimpleMember&gt; memberList
        = <span class="attribute">memberBhv</span>.outsideSql().selectList(path, pmb, entityType);
</code></pre>
	<h3 id="log">外だしSQLの実行ログ</h3>
	<p>
		外だしSQLの実行ログ(表示用SQLも含む)は以下のようになります。
	</p>
	<div class="relatedpage"><a href="../../genbafit/implfit/debuglog/index.html">現場フィット - デバッグログ</a></div>
	<div class="relatedpage"><a href="../../genbafit/implfit/displaysql/index.html">現場フィット - 表示用SQL</a></div>
<pre><span class="codetitle">ex) リスト検索のテスト実装のログ @Log</span><code>
(XLog#log():38) - /========================================================================================
(XLog#log():38) -                                                       MemberBhv.outsideSql().selectList()
(XLog#log():38) -                                                       ==================================/
(XLog#log():38) - BehaviorBasicTest.test_outsideSql_selectList_selectSimpleMember_Tx():457 -> ...
(XLog#log():38) - path: selectSimpleMember
(XLog#log():38) - option: {paging=non, dynamic=false}
(QLog#log():38) - 
<span class="comment">/*
 [df:title]
 シンプルな会員検索のExample
 
 [df:description]
 このSQLはOutsideSqlの最も基本的なExampleです。
 参考ポイント：
   o パラメータコメント(IFコメントやバインド変数コメントなど)の利用方法
   o Sql2Entityで生成するCustomizeEntityとParameterBeanの定義方法
   o 外だしSQLの業務的なタイトル・説明(SchemaHTMLにて表示される)の記述方法
 外だしSQLのエンコーディングはデフォルトで「UTF-8」です。
 ダブルバイト文字を利用する場合はエディタのエンコーディングにご注意下さい。
 補足：
   o この外だしSQLと同じSQLはConditionBeanで実現可能
*/
-- #df:entity#

-- !df:pmb!
-- !!Integer memberId!!
-- !!String memberName:likePrefix!!
</span>
<span class="keyword">select</span> member.MEMBER_ID
     , member.MEMBER_NAME
     , member.BIRTHDATE
     , memberStatus.MEMBER_STATUS_NAME
  <span class="keyword">from</span> MEMBER member
    <span class="keyword">left outer join</span> MEMBER_STATUS memberStatus
      <span class="keyword">on</span> member.MEMBER_STATUS_CODE = memberStatus.MEMBER_STATUS_CODE
 
 <span class="keyword">where</span>
   
   member.MEMBER_NAME <span class="keyword">like</span> <span class="literal">'S%'</span> <span class="keyword">escape</span> <span class="literal">'|'</span> 
   
   
 
 <span class="keyword">order by</span> member.BIRTHDATE <span class="keyword">desc</span>, member.MEMBER_ID <span class="keyword">asc</span>
(XLog#log():38) - ===========/ [00m00s063ms (4) first={12, Suker, 1968-01-01, 仮会員}@ef28f3f]
(XLog#log():38) -  
</code></pre>

	<h2 id="bhvinstance">Behaviorインスタンスの取得</h2>
	<p>
		Behaviorインスタンスは <em class="keyword">DIコンテナから取得</em> します。
	</p>
	<div class="detailpage"><a href="../behavior/howto.html">Behaviorの使い方</a></div>

	<h2 id="freestylebasic">フリースタイル基本仕様</h2>
	<p>
		フリースタイルにおける全てメソッドで共通の基本仕様です。
		ここにない情報はそれぞれのメソッドの詳細をご覧下さい。
	</p>
	<h3 id="sqlpath">SQLのパス (path)</h3>
	<p>
		主に第一引数で指定します。必須の引数なので null を指定してはいけません。
	</p>
	<p>
		String型ですが、基本的には BehaviorQueryPath を利用することで簡単に指定できます。
		BehaviorQueryPath を利用しない場合は、"/" (スラッシュ)区切りのクラスパスからのファイルパスとなります。
	</p>
	<div class="relatedpage"><a href="../../generator/task/sql2entity/behaviorquerypath.html">Sql2Entity - BehaviorQueryPath</a></div>
	<p>
		存在しないパスを指定した場合は、OutsideSqlNotFoundException が発生します。
	</p>
	<h3 id="pmb">ParameterBean (pmb)</h3>
	<p>
		SQLへ渡すパラメータがない場合は null 指定できます。
	</p>
	<p>
		Object型なので、(推奨されませんが)自動生成していないクラスも指定できます。また、パラメータが一つだけの場合は、String
		型や Integer 型などの値をそのまま指定することもできます。但し、その場合、ParameterBeanの空文字フィルタやもろもろのオプションは利用できません。
	</p>
	<div class="relatedpage"><a href="#parameterbeanmark">this - ParameterBeanマーク</a></div>
	<h3 id="cmentity">CustomizeEntity (entityType)</h3>
	<p>
		主に検索時(かつ、カーソル検索でない)において戻り値Entityの型を第三引数で指定します。
		必須の引数なので null を指定してはいけません。Entity ではなく String や Integer
		などのスカラ型も指定できます(これらも広い意味でEntityと概念付けます)。
	</p>

	<h2 id="completion">コード補完を駆使して実装</h2>
	<p>
		外だしSQLとはいえ、せめて呼び出す処理に関しては、コード補完で実装しましょう。
		メソッド名を一字一句丁寧に打ち込むというようなことはやらずに、<em class="keyword">メソッドの先頭の文字を打ち込んでメソッド候補を補完</em>
		して、利用したいメソッドを選んで実装していくようにします。ここでは Eclipse を基本として説明します。
	</p>
	<h3 id="firstchar">先頭文字を覚えておくのが大事</h3>
	<p>
		外だしSQLのメソッドは多くありません。ゆえに、先頭文字さえ打ってしまえば、その時点でほとんどメソッドを呼び出したも同然です。
	</p>
	<p>
		まずは、必ず唱える outsideSql() メソッド。Behaviorには、"o" で始まる public
		メソッドは他にありません。".o" と打って enter とするだけで呼び出せます。
	</p>
<pre><span class="codetitle">ex) Eclipseでのショートカット (outsideSql()を一文字で補完) @Java</span><code>
memberBhv<span class="point">.o</span> <span class="comment">// ".o" とだけ打って enter</span>
 <span class="attribute">to</span>
memberBhv.<span class="point">outsideSql()</span> <span class="comment">// 続けて "." と打って続きのメソッドを補完</span>
</code></pre>
	<p>
		外だしSQLで頻繁に利用されるリスト検索 selectList() は、outsideSql()の直後で唯一の "s" で始まるメソッドです。".s"
		と打って enter とするだけで呼び出せます。
	</p>
<pre><span class="codetitle">ex) Eclipseでのショートカット (selectList()を一文字で補完) @Java</span><code>
memberBhv.outsideSql()<span class="point">.s</span> <span class="comment">// ".s" とだけ打って enter</span>
 <span class="attribute">to</span>
memberBhv.outsideSql().<span class="point">selectList(pmb)</span>; <span class="comment">// 最後にセミコロンを</span>
</code></pre>
	<p>
		その他メソッド(経由するメソッドも含む)に関しても、先頭文字をおおよそ把握しておくとさらに良いでしょう。
	</p>
	<div class="detailpage"><a href="./index.html#function">外だしSQLの機能</a></div>
	<h3 id="autoresult">戻り値の抽出</h3>
	<p>
		これは、Behaviorで紹介しているものと全く同じです。特に外だしSQLは、戻り値の型は Generic
		で指定しますので、戻り値の型は自動で抽出するのがお奨めです。
	</p>
	<div class="detailpage"><a href="../behavior/howto.html#autoresult">Behavior - 戻り値の抽出</a></div>

</div>
</div>

<div id="sidebar">
	<div class="logo"><a href="../../../../../"><img src="../../../../../image/parts/logo.png" alt="dbflute-logo" width="240" height="110" /></a></div>
<ul>
		<li><a href="../../../../../ja/manual/function/generator/index.html">自動生成ツール</a>
			<ul>
				<li><a href="../../../../../ja/manual/function/generator/client/index.html">DBFluteクライアント</a></li>
				<li><a href="../../../../../ja/manual/function/generator/module/index.html">DBFluteモジュール</a></li>
				<li><a href="../../../../../ja/manual/function/generator/task/index.html">DBFluteタスク</a>
				<!-- 
					<ul>
						<li><a href="../../../../../ja/manual/function/generator/task/jdbc/index.html">JDBC</a></li>
						<li><a href="../../../../../ja/manual/function/generator/task/generate/index.html">Generate</a></li>
						<li><a href="../../../../../ja/manual/function/generator/task/doc/index.html">Doc</a></li>
						<li><a href="../../../../../ja/manual/function/generator/task/sql2entity/index.html">Sql2Entity</a></li>
						<li><a href="../../../../../ja/manual/function/generator/task/outsidesqltest/index.html">OutsideSqlTest</a></li>
						<li><a href="../../../../../ja/manual/function/generator/task/replaceschema/index.html">ReplaceSchema</a></li>
					</ul>
				 -->
				</li>
			</ul>
		</li>
		<li><a href="../../../../../ja/manual/function/ormapper/index.html">O/Rマッパ</a>
			<ul>
				<li><a href="../../../../../ja/manual/function/ormapper/behavior/index.html">Behavior</a></li>
				<li><a href="../../../../../ja/manual/function/ormapper/conditionbean/index.html">ConditionBean</a></li>
				<li class="upper-space"><a href="../../../../../ja/manual/function/ormapper/outsidesql/index.html">OutsideSql</a></li>
				<li><a href="../../../../../ja/manual/function/ormapper/entity/index.html">Entity</a></li>
				<li><a href="../../../../../ja/manual/function/ormapper/runtime/index.html">DBFluteランタイム</a></li>
			</ul>
		</li>
		<li>
			<a href="../../../../../ja/manual/function/genbafit/index.html">現場フィット</a>
			<ul>
				<li><a href="../../../../../ja/manual/function/genbafit/implfit/index.html">アプリ実装の全体最適</a></li>
				<li><a href="../../../../../ja/manual/function/genbafit/projectfit/index.html">プロジェクト構成対応</a></li>
				<li class="upper-space"><a href="../../../../../ja/manual/function/genbafit/runtimefit/index.html">実行時共通要件の実現</a></li>
				<li><a href="../../../../../ja/manual/function/genbafit/deprecatedfit/index.html">非推奨な構造フォロー</a></li>
				<li><a href="../../../../../ja/manual/function/genbafit/dbflutefit/index.html">DBFluteサポート</a></li>
			</ul>
		</li>
		<li><a href="../../../../../ja/manual/function/helper/index.html">支援ツール</a>
			<ul>
				<li><a href="../../../../../ja/manual/function/helper/emecha/index.html">EMecha(Eclipse Plugin)</a></li>
				<li><a href="../../../../../ja/manual/function/helper/maven/index.html">Maven DBFlute Plugin</a></li>
			</ul>
		</li>
		<li><a href="../../../../../ja/manual/reference/index.html">リファレンス</a>
			<ul>
				<li><a href="../../../../../ja/manual/reference/dbway/index.html">DBMSごとの取扱い</a></li>
				<li><a href="../../../../../ja/manual/reference/diway/index.html">DIコンテナごとの取扱い</a></li>
				<li class="upper-space"><a href="../../../../../ja/manual/reference/dfprop/index.html">DBFluteプロパティ</a></li>
				<li><a href="../../../../../ja/manual/reference/dictionary/index.html">DBFlute用語集</a></li>
				<li><a href="../../../../../ja/manual/reference/example/index.html">DBFlute Example</a></li>
				<li class="upper-space"><a href="../../../../../ja/manual/reference/faq/index.html">FAQ</a></li>
				<li><a href="../../../../../ja/manual/reference/troubleshooting/index.html">トラブルシューティング</a></li>
			</ul>
		</li>
		<li><a href="../../../../../ja/manual/topic/index.html">トピック</a>
			<ul>
				<li><a href="../../../../../ja/manual/topic/dbdesign/index.html">DB設計</a></li>
				<li><a href="../../../../../ja/manual/topic/programming/index.html">プログラミング</a></li>
				<li><a href="../../../../../ja/manual/topic/friends/index.html">他のフレームワーク</a></li>
				<li class="upper-space"><a href="../../../../../ja/manual/topic/office/index.html">事務的な話</a></li>
				<li><a href="../../../../../ja/manual/topic/dbflutenet/index.html">DBFlute.NET</a></li>
			</ul>
		</li>
	</ul>

</div>

<div id="footer">
	<div><a href="../../../../../ja/sitemap.html">SiteMap</a> <a href="http://d.hatena.ne.jp/jflute">Author's Blog</a><a href="https://www.seasar.org/issues/browse/DBFLUTE">BTS</a></div>
	<ul class="footer-navi">
		<li class="hd-introduction"><a href="../../../../../ja/introduction/index.html">Introduction</a></li>
		<li class="hd-tutorial"><a href="../../../../../ja/tutorial/index.html">Tutorial</a>
			<ul>
				<li class="hd-architect"><a href="../../../../../ja/tutorial/architect.html">for Architect</a></li>
				<li class="hd-developer"><a href="../../../../../ja/tutorial/developer.html">for Developer</a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../../ja/environment/index.html">Environment</a>
			<ul>
				<li class="hd-install"><a href="../../../../../ja/environment/setup/index.html">Setup</a></li>
				<li class="hd-upgrade"><a href="../../../../../ja/environment/upgrade/index.html">Upgrade</a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../../ja/manual/index.html">Manual</a></li>
	</ul>

</div>

</div>
</body>
</html>
