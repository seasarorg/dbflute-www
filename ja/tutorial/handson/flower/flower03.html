<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta name="keywords" content="DBFlute,チュートリアル,ハンズオン,hands-on" />
	<link rel="stylesheet" type="text/css" href="../../../../css/sub.css" />
	<!--[if IE 6.0]>
		<link rel="stylesheet" type="text/css" href="../../../../css/cb/sub.css" />
	<![endif]--> 
	<title>模範解答的なセクション 3 | DBFlute</title>
</head>
<body>
<div id="container" class="ct-tutorial">

<div id="mainbar">
<div id="header">
	<div class="navi-upper"><a href="../../../../ja/sitemap.html">SiteMap</a>|<a href="http://d.hatena.ne.jp/jflute/">Author's Blog</a></div>
	<div class="navi-main">
	<ul>
		<li class="hd-introduction"><a href="../../../../ja/introduction/index.html"><img src="../../../../image/parts/navi/link-intro.png" alt="Introduction" width="75" height="32" /></a></li>
		<li class="hd-tutorial"><a href="../../../../ja/tutorial/index.html"><img src="../../../../image/parts/navi/link-tuto.png" alt="Tutorial" width="56" height="24" /></a>
			<ul>
				<li class="hd-architect"><a href="../../../../ja/tutorial/architect.html"><img src="../../../../image/parts/navi/link-arch.png" alt="for Architect" width="80" height="24" /></a></li>
				<li class="hd-developer"><a href="../../../../ja/tutorial/developer.html"><img src="../../../../image/parts/navi/link-dev.png" alt="for Developer" width="87" height="24" /></a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../ja/environment/index.html"><img src="../../../../image/parts/navi/link-env.png" alt="Environment" width="84" height="25" /></a>
			<ul>
				<li class="hd-install"><a href="../../../../ja/environment/setup/index.html"><img src="../../../../image/parts/navi/link-setup.png" alt="Setup" width="42" height="24" /></a></li>
				<li class="hd-upgrade"><a href="../../../../ja/environment/upgrade/index.html"><img src="../../../../image/parts/navi/link-upgrade.png" alt="Upgrade" width="61" height="25" /></a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../ja/manual/index.html"><img src="../../../../image/parts/navi/link-manual.png" alt="Manual" width="62" height="25" /></a></li>
	</ul>
	</div>
</div>

<div id="content">
	<h1>模範解答的なセクション 3</h1>
	<ul class="indexlist">
		<li><a href="#overview">概要</a></li>
		<li><a href="#stakeholder">このセクションでの登場人物</a></li>
		<li><a href="#flowerimpl">模範解答的な実装</a></li>
	</ul>

	<h2 id="overview">概要</h2>
	<p>
		DBFluteハンズオン、セクション 3 の模範解答的な実装です。
	</p>
	<div class="relatedpage"><a href="../section03.html">ハンズオンセクション 3</a></div>
	<p>
		正解は一つではありませんので、あくまで "的な" というところで、参考までに。
	</p>

	<h2 id="stakeholder">このセクションでの登場人物</h2>
<pre><span class="codetitle">e.g. このセクションでの登場人物 @Directory</span><code>
dbflute-hands-on
 |-src/test/java
 |  |-org.docksidestage.handson
 |  |  |-exercise
 |  |  |  |-<span class="spotlight"><span class="point">HandsOn03Test.java</span></span>
 |  |  |
 |  |  |-unit
 |-src/main/java
 |-<span class="abbreviation">...</span>
</code></pre>

	<h2 id="flowerimpl">模範解答的な実装</h2>
<pre><span class="codetitle">e.g. 模範解答的な実装やってみた @Java</span><code>
<span class="comment">/**
 * @author jflute
 */</span>
<span class="keyword">public class</span> HandsOn03Test <span class="keyword">extends</span> UnitContainerTestCase {

    <span class="comment">// ===================================================================================
    //                                                                           Attribute
    //                                                                           =========</span>
    @Resource
    <span class="keyword">protected</span> MemberBhv <span class="attribute">memberBhv</span>;
    @Resource
    <span class="keyword">protected</span> MemberSecurityBhv <span class="attribute">memberSecurityBhv</span>;
    @Resource
    <span class="keyword">protected</span> PurchaseBhv <span class="attribute">purchaseBhv</span>;

    <span class="comment">// ===================================================================================
    //                                                                     Exercise 1 to 3
    //                                                                     ===============</span>
    <span class="comment">/**
     * [1] 会員名称がSで始まる1968年1月1日以前に生まれた会員を検索
     * o 会員ステータスも取得する
     * o 生年月日の昇順で並べる
     * o 会員が1968/01/01以前であることをアサート
     * o "以前" の解釈は、"その日ぴったりも含む" で。
     * ※もし、よければ HandyDate を使ってみましょう。
     */</span>
    <span class="keyword">public void</span> test_1() <span class="keyword">throws</span> Exception {
        <span class="comment">// ## Arrange ##</span>
        LocalDate targetDate = <span class="keyword">new</span> HandyDate(<span class="literal">"1968/01/01"</span>).getLocalDate(); <span class="comment">// HandyDateの紹介</span>

        <span class="comment">// ## Act ##</span>
        ListResultBean&lt;Member&gt; memberList = <span class="attribute">memberBhv</span>.selectList(<span class="localvar">cb</span> -&gt; {
            <span class="localvar">cb</span>.query().setMemberName_LikeSearch(<span class="literal">"S"</span>, <span class="localvar">op</span> -&gt; <span class="localvar">op</span>.likePrefix());
            <span class="localvar">cb</span>.query().setBirthdate_LessEqual(targetDate);
            <span class="localvar">cb</span>.query().addOrderBy_Birthdate_Asc();
        });

        <span class="comment">// ## Assert ##</span>
        assertHasAnyElement(memberList);
        memberList.forEach(member -&gt; {
            LocalDate birthdate = member.getBirthdate();
            log(member.getMemberName(), birthdate);
            assertTrue(birthdate.isBefore(targetDate) || birthdate.isEqual(targetDate));

            <span class="comment">// << いろいろなやり方がある >></span>
            assertFalse(birthdate.isAfter(targetDate));
            assertTrue(<span class="keyword">new</span> HandyDate(birthdate).isLessEqual(targetDate));
        });
    }

    <span class="comment">/**
     * [2] 会員ステータスと会員セキュリティ情報も取得して会員を検索
     * o 若い順で並べる。生年月日がない人は会員IDの昇順で並ぶようにする
     * o 会員ステータスと会員セキュリティ情報が存在することをアサート
     * ※カージナリティを意識しましょう
     */</span>
    <span class="keyword">public void</span> test_2() <span class="keyword">throws</span> Exception {
        <span class="comment">// ## Arrange ##</span>
        <span class="comment">// ## Act ##</span>
        ListResultBean&lt;Member&gt; memberList = <span class="attribute">memberBhv</span>.selectList(<span class="localvar">cb</span> -&gt; {
            <span class="localvar">cb</span>.setupSelect_MemberStatus();
            <span class="localvar">cb</span>.setupSelect_MemberSecurityAsOne();
        });

        <span class="comment">// ## Assert ##</span>
        <span class="comment">// 会員から会員ステータスは、NotNullのFKカラムで参照しているので、探しにいけば必ず存在する
        // 会員から会員セキュリティは、FKの方向と探しにいく方向が逆なので同じ理論にはなりませんが、
        // ERDのリレーション線に注目。会員退会情報と比べると一目瞭然、黒丸がついていないので必ず存在する1
        //   会員から会員セキュリティ => 1:必ず1 (1:1)
        //   会員から会員退会情報    => 1:いないかもしれない1 (1:0..1)
        // ただ、物理的な制約はありません。業務的というのは、そういうルールにしているいうことだけなんですね。
        // 細かいですが、これがデータベースプログラミングにおいて、とても重要なんですよね。
        // ぜひ、カージナリティに着目してみてください。</span>
        assertHasAnyElement(memberList);
        memberList.forEach(member -&gt; {
            assertTrue(member.getMemberStatus().isPresent());
            assertTrue(member.getMemberSecurityAsOne().isPresent());
        });
    }

    <span class="comment">/**
     * [3] 会員セキュリティ情報のリマインダ質問で2という文字が含まれている会員を検索
     * o 会員セキュリティ情報のデータ自体は要らない
     * o リマインダ質問に2が含まれていることをアサート
     * o アサートするために別途検索処理を入れても誰も文句は言わない
     * ※Actでの検索は本番でも実行されることを想定して、テスト都合でパフォーマンス劣化させないように
     * ※実装できたら、こんどはアサートのための検索の回数が一回になるようにしてみましょう(もし、複数回検索しているのであれば)。
     * また、それもできたら、会員名称とリマインダ質問を会員ごとに一行のログに出力してみましょう。
     */</span>
    <span class="keyword">public void</span> test_3() <span class="keyword">throws</span> Exception {
        <span class="comment">// ## Arrange ##</span>
        String keyword = <span class="literal">"2"</span>;

        <span class="comment">// ## Act ##</span>
        ListResultBean&lt;Member&gt; memberList = <span class="attribute">memberBhv</span>.selectList(<span class="localvar">cb</span> -&gt; {
            <span class="localvar">cb</span>.query().queryMemberSecurityAsOne().setReminderQuestion_LikeSearch(keyword, <span class="localvar">op</span> -&gt; <span class="localvar">op</span>.likeContain());
        });

        <span class="comment">// ## Assert ##</span>
        assertHasAnyElement(memberList);

        <span class="comment">// << べたべたパターン: ループの中で検索してるのがちょっとよくない >></span>
        memberList.forEach(member -&gt; {
            <span class="attribute">memberSecurityBhv</span>.selectByPK(member.getMemberId()).alwaysPresent(security -&gt; {
                String question = security.getReminderQuestion();
                log(member.getMemberName(), question);
                assertTrue(question.contains(keyword));
            });
        });

        <span class="comment">// << SQLを救出パターン >></span>
        <span class="comment">// IDの抽出、stream()でこう書ける
        //List&lt;Integer&gt; memberIdList = memberList.stream().map(member -&gt; {
        //    return member.getMemberId();
        //}).collect(Collectors.toList());
        // でも、ExtractColumnを使うのが一番</span>
        ListResultBean&lt;MemberSecurity&gt; securityList = <span class="attribute">memberSecurityBhv</span>.selectList(<span class="localvar">cb</span> -&gt; {
            <span class="localvar">cb</span>.query().setMemberId_InScope(<span class="attribute">memberBhv</span>.extractMemberIdList(memberList));
        });
        memberList.forEach(member -&gt; {
            securityList.forEach(security -&gt; {
                <span class="keyword">if</span> (member.getMemberId().equals(security.getMemberId())) {
                    String question = security.getReminderQuestion();
                    log(member.getMemberName(), question);
                    assertTrue(question.contains(keyword));
                    markHere(<span class="literal">"exists"</span>);
                    <span class="comment">// あっ、breakできない!?</span>
                }
            });
            assertMarked(<span class="literal">"exists"</span>);
        });

        <span class="comment">// << Mapにしちゃうパターン!? >></span>
        <span class="comment">// Mapの作り方、collect()が使えるけど、今までのやり方でも Lambda 使えばそれなりにいいかんじ!?
        //Map<Integer, MemberSecurity> securityMap = newHashMap();
        //securityList.forEach(security -> securityMap.put(security.getMemberId(), security));</span>
        Map<Integer, MemberSecurity> securityMap =
                securityList.stream().collect(Collectors.toMap(bean -> bean.getMemberId(), bean -> bean));
        memberList.forEach(member -&gt; {
            MemberSecurity security = securityMap.get(member.getMemberId());
            String question = security.getReminderQuestion();
            log(member.getMemberName(), question);
            assertTrue(question.contains(keyword));
        });
    }

    <span class="comment">// ===================================================================================
    //                                                                     Exercise 4 to 6
    //                                                                     ===============</span>
    <span class="comment">/**
     * [4] 会員ステータスの表示順カラムで会員を並べて検索
     * o 会員ステータスの "表示順" カラムの昇順で並べる
     * o 会員ステータスのデータ自体は要らない
     * o その次には、会員の会員IDの降順で並べる
     * o 会員ステータスのデータが取れていないことをアサート
     * o 会員が会員ステータスごとに固まって並んでいることをアサート
     */</span>
    <span class="keyword">public void</span> test_4() <span class="keyword">throws</span> Exception {
        <span class="comment">// ## Arrange ##</span>
        <span class="comment">// ## Act ##</span>
        ListResultBean&lt;Member&gt; memberList = <span class="attribute">memberBhv</span>.selectList(<span class="localvar">cb</span> -&gt; {
            <span class="localvar">cb</span>.query().queryMemberStatus().addOrderBy_DisplayOrder_Asc();
            <span class="localvar">cb</span>.query().addOrderBy_MemberId_Desc();
        });

        <span class="comment">// ## Assert ##</span>
        assertHasAnyElement(memberList);

        <span class="comment">// << forEach()使ってみたパターン >></span>
        Set&lt;String&gt; statusSet = <span class="keyword">new</span> HashSet&lt;String&gt;();
        Stack&lt;Member&gt; mbStack = <span class="keyword">new</span> Stack&lt;Member&gt;();
        memberList.forEach(member -&gt; {
            assertFalse(member.getMemberStatus().isPresent());
            String previous = !mbStack.isEmpty() ? mbStack.peek().getMemberStatusCode() : <span class="keyword">null</span>;
            String current = member.getMemberStatusCode();
            log(previous, current);
            <span class="keyword">if</span> (previous != null && !previous.equals(current)) {
                assertFalse(statusSet.contains(current));
            }
            statusSet.add(current);
            mbStack.add(member);
        });

        <span class="comment">// << 普通のfor文のパターン >></span>
        statusSet.clear(); <span class="comment">// ちと再利用させて</span>
        String previous = <span class="keyword">null</span>;
        <span class="keyword">for</span> (Member member : memberList) {
            assertFalse(member.getMemberStatus().isPresent());
            String current = member.getMemberStatusCode();
            log(previous, current);
            <span class="keyword">if</span> (previous != null && !previous.equals(current)) {
                assertFalse(statusSet.contains(current));
            }
            statusSet.add(current);
            previous = current;
        }

        <span class="comment">// << というか、違うやり方 >></span>
        statusSet.clear(); <span class="comment">// また再利用させて</span>
        previous = null; <span class="comment">// こっちも</span>
        <span class="keyword">int</span> switchCount = <span class="literal">0</span>;
        <span class="keyword">for</span> (Member member : memberList) {
            assertFalse(member.getMemberStatus().isPresent());
            String current = member.getMemberStatusCode();
            log(previous, current);
            <span class="keyword">if</span> (previous != null && !previous.equals(current)) {
                ++switchCount;
            }
            statusSet.add(current);
            previous = current;
        }
        assertEquals(statusSet.size(), switchCount);
    }

    <span class="comment">/**
     * [5] 生年月日が存在する会員の購入を検索
     * o 会員名称と会員ステータス名称と商品名も一緒に取得(ログ出力)
     * o 購入日時の降順、購入価格の降順、商品IDの昇順、会員IDの昇順で並べる
     * o OrderBy がたくさん追加されていることをログで確認すること
     * o 購入に紐づく会員の生年月日が存在することをアサート
     * ※ログ出力は、スーパークラスの log() メソッドが利用できる。可変長引数でカンマ区切り出力になる。
     */</span>
    public void test_5() throws Exception {
        <span class="comment">// ## Arrange ##
        // ## Act ##</span>
        ListResultBean&lt;Purchase&gt; purchaseList = <span class="attribute">purchaseBhv</span>.selectList(<span class="localvar">cb</span> -&gt; {
            <span class="localvar">cb</span>.setupSelect_Member().withMemberStatus();
            <span class="localvar">cb</span>.setupSelect_Product();
            <span class="localvar">cb</span>.query().queryMember().setBirthdate_IsNotNull();
            <span class="localvar">cb</span>.query().addOrderBy_PurchaseDatetime_Desc();
            <span class="localvar">cb</span>.query().addOrderBy_PurchasePrice_Desc();
            <span class="localvar">cb</span>.query().addOrderBy_ProductId_Asc();
            <span class="localvar">cb</span>.query().addOrderBy_MemberId_Asc();
        });

        <span class="comment">// ## Assert ##</span>
        assertHasAnyElement(purchaseList);
        purchaseList.forEach(purchase -&gt; {
            Member member = purchase.getMember().get();
            MemberStatus status = member.getMemberStatus().get();
            Product product = purchase.getProduct().get();
            log(purchase.getProductId(), member.getMemberName(), status.getMemberStatusName(), product.getProductName(),
                    member.getMemberId());
        });
    }

    // TODO jflute ６番からまだやってない
}
</code></pre>

</div>
</div>

<div id="sidebar">
	<div class="logo"><a href="../../../../"><img src="../../../../image/parts/logo.png" alt="dbflute-logo" width="240" height="110" /></a></div>
<ul>
		<li><a href="../../../../ja/tutorial/architect.html">アーキテクトのチュートリアル</a>
			<ul>
				<li><a href="../../../../ja/tutorial/architect.html#knowledge">必要な知識</a></li>
				<li><a href="../../../../ja/tutorial/architect.html#action">開発時にやるべきこと</a></li>
			</ul>
		</li>
		<li><a href="../../../../ja/tutorial/developer.html">ディベロッパーのチュートリアル</a>
			<ul>
				<li><a href="../../../../ja/tutorial/developer.html#about">DBFluteとは？</a></li>
				<li><a href="../../../../ja/tutorial/developer.html#style">実装スタイル</a></li>
				<li><a href="../../../../ja/tutorial/developer.html#policy">ディベロッパーの十か条</a></li>
				<li class="upper-space"><a href="../../../../ja/tutorial/developer.html#faq">ディベロッパーのFAQ</a></li>
				<li><a href="../../../../ja/tutorial/developer.html#supplement">補足資料</a></li>
			</ul>
		</li>
		<li><a href="../../../../ja/tutorial/handson/index.html">DBFluteハンズオン</a>
			<ul>
				<li><a href="../../../../ja/tutorial/handson/section01.html">Section 1</a></li>
				<li><a href="../../../../ja/tutorial/handson/section02.html">Section 2</a></li>
				<li><a href="../../../../ja/tutorial/handson/section03.html">Section 3</a></li>
				<li class="upper-space"><a href="../../../../ja/tutorial/handson/section04.html">Section 4</a></li>
				<li><a href="../../../../ja/tutorial/handson/section05.html">Section 5</a></li>
				<li class="upper-space"><a href="../../../../ja/tutorial/handson/section06.html">Section 6</a></li>
				<li><a href="../../../../ja/tutorial/handson/section07.html">Section 7</a></li>
				<li><a href="../../../../ja/tutorial/handson/section08.html">Section 8</a></li>
				<li class="upper-space"><a href="../../../../ja/tutorial/handson/section09.html">Section 9</a></li>
				<li><a href="../../../../ja/tutorial/handson/section10.html">Section 10</a></li>
				<li><a href="../../../../ja/tutorial/handson/section11.html">Section 11</a></li>
			</ul>
		</li>
	</ul>

</div>

<div id="footer">
	<div><a href="../../../../ja/sitemap.html">SiteMap</a> <a href="http://d.hatena.ne.jp/jflute">Author's Blog</a><a href="https://www.seasar.org/issues/browse/DBFLUTE">BTS</a></div>
	<ul class="footer-navi">
		<li class="hd-introduction"><a href="../../../../ja/introduction/index.html">Introduction</a></li>
		<li class="hd-tutorial"><a href="../../../../ja/tutorial/index.html">Tutorial</a>
			<ul>
				<li class="hd-architect"><a href="../../../../ja/tutorial/architect.html">for Architect</a></li>
				<li class="hd-developer"><a href="../../../../ja/tutorial/developer.html">for Developer</a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../ja/environment/index.html">Environment</a>
			<ul>
				<li class="hd-install"><a href="../../../../ja/environment/setup/index.html">Setup</a></li>
				<li class="hd-upgrade"><a href="../../../../ja/environment/upgrade/index.html">Upgrade</a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../ja/manual/index.html">Manual</a></li>
	</ul>

</div>

</div>
</body>
</html>
