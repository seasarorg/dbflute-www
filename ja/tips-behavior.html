<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head>
<title>Seasar - DI Container with AOP - </title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen" />
<link href="seasar_p.css" type="text/css" rel="stylesheet" media="print" />
<script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head>
<body onload="preload('ja')">
<table width="100%" border="0" cellspacing="0" cellpadding="0" align="left"><tr>
<td align="left" valign="top" width="780"><table width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr><td colspan="7"><img height="5" width="780" src="images/top01_b.gif" alt=""></td></tr>
<tr><td><img height="117" width="235" src="images/top02_b.gif" alt="Seasar"></td>
<td colspan="3"><img height="117" width="289" src="images/top03.gif" alt="DI Container with AOP"></td>
<td colspan="3"><img height="117" width="256" src="images/spacer.gif" alt=""></td>
</tr><tr><td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" height="30" width="110" border="0" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)"></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" height="30" width="113" border="0" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)"></a></td>
<td><img src="images/menu05_b_ja.gif" height="30" width="109" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></td>
<td><img height="30" width="34" src="images/menu06.gif" alt=""></td></tr><tr>
<td colspan="6"><img height="19" width="545" src="images/spacer.gif" alt=""></td></tr></table>
<table  width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr align="left" valign="top"><td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td><td width="740" class="main">
<!-- don't edit end -->
<!-- document start -->
<p>
<a href="index.html">to Top</a>
<p><b>
Behaviorについて記述します。
<p></b>
<pre>


// ======================================================================================================
//                                                                                               Behavior
//                                                                                               ========

# ------------------------------------------------
#                                What is behavior?
#                                -----------------

Dataの振舞いを定義するObjectです。

ある画面「S1」でTable「T1」に対して行う処理を、とある画面「S2」においても行う場合は、
それは、「T1」のBehaviorにMethodを定義して「S1」と「S2」から再利用できるようにします。
そのうち、「T1」への同じ処理が含まれる「S3」が出てくるかもしれません。
そのときは、Behaviorに定義した呼べばよいだけです。

再利用をどのような基準で行うかはProjectによって様々ですが、DBFluteではこのような領域を用意しています。
また、Behaviorに上記のような独自のMethodを定義しなくても、GenerateされたSuperClassのBehaviorには
便利なMethodが数多く存在します。それを利用するだけでも十分価値があります。



# ------------------------------------------------
#                              How to use behavior
#                              -------------------

Behaviorは、dao.diconにてInterfaceを持たないClassとしてComponent登録されます。
Interfaceを持たないため、Setter-Injectionされるか否かはS2ContainerのVersionに依存します。

Interfaceを持たないComponentもSetter-InjectionされるVersionの場合は、
利用したいBehaviorのComponentのNameをProperty名としてSetterを用意すればInjectionされます。

    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    public class Xxx {
        public void setBookBhv(LdBookBhv bookBhv) {
            this.bookBhv = bookBhv;
        }
        public void executeXxx() {
            final LdBook entity = LdBook();
            entity.setBookId(123);
            entity.setBookName("xxx");
            this.bookBhv.insertOrUpdateAfterSelect(cb);
        }
    }
    - - - - - - - - /


そうでない場合は、S2ContainerからgetComponentするか、もしくは、DaoSelectorなるComponentから
BehaviorのInstanceを取得します。
DaoSelectorは、全てのDaoとBehaviorへの参照を保持しています。DaoSelector自体がComponent登録されているため、
Setter-Injectionされるので、DaoSelectorのSetterを用意してDaoSelectorからBehaviorを取得します。

    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    public class Xxx {
        public void setDaoSelector(LdDaoSelector daoSelector) {
            this.daoSelector = daoSelector;
        }
        public void executeXxx() {
            final LdBook entity = LdBook();
            entity.setBookId(123);
            entity.setBookName("xxx");
            final LdBookBhv bhv = (LdBookBhv)this.daoSelector.getWBhv(LdBookBhv.class);
            bhv.insertOrUpdateAfterSelect(cb);
        }
    }
    - - - - - - - - /



# -------------------------------------------------
#          What kind of methods does behavior have?
#          ----------------------------------------

_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
                  用途別Method概要
                _/_/_/_/_/_/_/_/_/

<a href="tips-behavior-method_for_use.html">Behaviorの用途別Method概要</a> をご覧下さい。



_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
                        Method詳細
                _/_/_/_/_/_/_/_/_/



TODO: 以下書き途中です。。。




    // =====================================================================================
    //                                                                    Basic Select Count
    //                                                                    ==================
    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Select count by condition-bean.
     * 
     * If the argument 'condition-bean' is effective about fetch-scope,
     * this method invoke select count ignoring the fetch-scope.
     * 
     * @param cb Condition-bean. This condition-bean should not be set up about fetch-scope. (NotNull)
     * @return Selected count. (NotNull)
     */
    public int selectCount(LdBookCB cb) {
        assertConditionBeanNotNull(cb);
        return delegateSelectCount(cb);
    }
    - - - - - - - - /

        ConditionBeanによるCount検索です。
        もし、引数のConditionBeanに fetchFirst()やFetchPage()などが呼び出されていて
        ConditionBeanのFetchScope設定が有効な場合、このMethodはその設定を無視して処理します。
        例えば、342件取得できるはずのConditionBeanの検索条件にfetchFirst(20)/fetchPage(5)と設定されていた場合
        このConditionBeanを selectSimpleCount(cb); で呼び出すと、342件が取得されます。


    // =====================================================================================
    //                                                                   Basic Select Entity
    //                                                                   ===================
    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Select entity by condition-bean.
     * 
     * @param cb Condition-bean. (NotNull)
     * @return Selected entity. (Nullalble)
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasOverlappedException
     */
    public LdBook selectEntity(LdBookCB cb) {
        assertConditionBeanNotNull(cb);
        final java.util.List&lt;LdBook&gt; ls = delegateSelectList(cb);
        if (ls.isEmpty()) {
            return null;
        }
        assertRecordHasBeenSelectedAsOne(ls, cb.toString());
        return (LdBook)ls.get(0);
    }
    - - - - - - - - /

        ConditionBeanによるEntity検索です。
        該当の条件で検索結果が0件の場合は、nullが戻ります。
        該当の条件で検索結果が複数件の場合は、専用の例外が発生します。


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Select entity by condition-bean with deleted check.
     * 
     * @param cb Condition-bean. (NotNull)
     * @return Selected entity. (NotNull)
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasAlreadyBeenDeletedException
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasOverlappedException
     */
    public LdBook selectEntityWithDeletedCheck(LdBookCB cb) {
        assertConditionBeanNotNull(cb);
        final java.util.List&lt;LdBook&gt; ls = delegateSelectList(cb);
        assertRecordHasNotBeenDeleted(ls, cb.toString());
        assertRecordHasBeenSelectedAsOne(ls, cb.toString());
        return currentEntity;
    }
    - - - - - - - - /

        ConditionBeanによる削除されたか否かをCheckするEntity検索です(nullを期待しない検索)。
        該当の条件で検索結果が0件の場合は、専用の例外が発生します。
        該当の条件で検索結果が複数件の場合は、専用の例外が発生します。


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /*
     * Select entity by primary-key with deleted check.
     * 
     * @param primaryKey
     * @return Selected entity. (NotNull)
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasAlreadyBeenDeletedException
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasOverlappedException
     */
    public LdBook selectByPKValueWithDeletedCheck(java.math.BigDecimal bookId) {
        LdBook entity = new LdBook();
        entity.setBookId(bookId);
        final LdBookCB cb = newMyConditionBean();
        cb.acceptPrimaryKeyMapString(entity.extractPrimaryKeyMapString());
        return selectEntityWithDeletedCheck(cb);
    }
    - - - - - - - - /

        PrimaryKeyを引数として削除されたか否かをCheckするEntity検索です。
        PrimaryKeyの存在しないTableでは作成されません。


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

    /*
     * Select entity by primary-key with deleted check for update .
     * 
     * @param primaryKey
     * @return Selected entity. (NotNull)
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasAlreadyBeenDeletedException
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasOverlappedException
     */
    public LdBook selectByPKValueWithDeletedCheckForUpdate(java.math.BigDecimal bookId) {
        LdBook entity = new LdBook();
        entity.setBookId(bookId);
        final LdBookCB cb = newMyConditionBean();
        cb.acceptPrimaryKeyMapString(entity.extractPrimaryKeyMapString());
        cb.lockForUpdate();
        return selectEntityWithDeletedCheck(cb);
    }
    - - - - - - - - /

        PrimaryKeyを引数として削除されたか否かをCheckする更新Lock付きのEntity検索です。
        PrimaryKeyの存在しないTableでは作成されません。


    // =====================================================================================
    //                                                                     Basic Select List
    //                                                                     =================
    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Select simple list.
     * 
     * @param cb Condition-bean. (NotNull)
     * @return Selected list. (NotNull)
     */
    public java.util.List<LdBook> selectSimpleList(LdBookCB cb) {
        assertConditionBeanNotNull(cb);
        return delegateSelectList(cb);
    }
    - - - - - - - - /

        ConditionBeanによるList検索です。


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    public LdListResultBean&lt;LdBook&gt; selectList(LdBookCB cb) {
        assertConditionBeanNotNull(cb);
        return new ResultBeanBuilder&lt;LdBook&gt;(this).buildListResultBean(cb, delegateSelectList(cb));
    }
    - - - - - - - - /

        指定されたConditionBeanで条件にHITする検索結果をListResultBeanの形で戻します。
          →ListResultBeanは、以下の要素を保持します。
              - 検索したTable名
              - 総件数
              - 検索結果(List)
              - OrderBy情報


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    public LdPagingResultBean&lt;LdBook&gt; selectPage(final LdBookCB cb) {
        assertConditionBeanNotNull(cb);
        return selectPage(cb, new SelectPageSimpleInvoker&lt;LdBook&gt;(this));
    }
    - - - - - - - - /

        指定されたConditionBeanで条件にHITするPagingの検索結果をPageResultBeanの形で戻します。
          →PageResultBeanは、以下の要素を保持します。
              - 検索したTable名 ｛ListResultBean継承｝
              - 総件数          ｛ListResultBean継承｝
              - 検索結果(List)  ｛ListResultBean継承｝
              - OrderBy情報     ｛ListResultBean継承｝
              - 1Page当たりのSize
              - 現在のPage番号
              - 総Page数
              - その他

            ※PageResultBeanは非常に便利なObjectです。参考｛<a href="./tips-paging.html">Tips: Paging</a>｝


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Select page.
     * 
     * @param cb Condition-bean. (NotNull)
     * @param invoker Select-page-invoker (NotNull)
     * @return Selected page as first page. (NotNull)
     */
    public LdPagingResultBean&lt;LdBook&gt; selectPage(final LdBookCB cb, SelectPageInvoker&lt;LdBook&gt; invoker) {
        assertConditionBeanNotNull(cb);
        final SelectPageCallback&lt;LdBook&gt; pageCallback = new SelectPageCallback&lt;LdBook&gt;() {
            public LdPagingBean getPagingBean() { return cb; }
            public int selectCountIgnoreFetchScope() {
                return delegateSelectCountIgnoreFetchScope(cb);
            }
            public java.util.List&lt;LdBook&gt; selectList() {
                return delegateSelectList(cb);
            }
        };
        return invoker.invokeSelectPage(pageCallback);
    }
    - - - - - - - - /

        selectPage(LdBookCB cb);と同様です。
        こちらは、Invokerを指定して、Paging検索時の挙動を独自に変更することができます。


    // =====================================================================================
    //                                                                         Load Refferer
    //                                                                         =============

    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Load refferer of collectionList.
     * 
     * @param ls Entity list of main table. (NotNull)
     */
    public void loadCollectionList(java.util.List&lt;LdBook&gt; ls) {
        LdBook entity = new LdBook();
        entity.setBookId(bookId);
        final LdBookCB cb = newMyConditionBean();
        cb.acceptPrimaryKeyMapString(entity.extractPrimaryKeyMapString());
        cb.lockForUpdate();
        return selectEntityWithDeletedCheck(cb);
    }
    - - - - - - - - /

        こちらに関しては、<a href="./tips-behavior-one_to_many_loading.html">Tips: Behavior - one-to-many loading</a> をご覧下さい。


    // =====================================================================================
    //                                                                          Basic Update
    //                                                                          ============

    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Insert or update after select.
     * {update: modified only}
     * 
     * @param entity Entity. This must contain primary-key value at least(Except use identity). (NotNull)
     * @return Updated count.
     */
    public int insertOrUpdateAfterSelect(LdBook entity) {
        assertEntityNotNull(entity);
        if (!entity.hasPrimaryKeyValue()) {
            return delegateInsert(entity);
        }
        LdBook currentEntity = null;
        try {
            final LdBookCB cb = newMyConditionBean();
            cb.acceptPrimaryKeyMapString(entity.extractPrimaryKeyMapString());
            currentEntity = selectEntityWithDeletedCheck(cb);
        } catch (dbflute.ldb.allcommon.exception.LdRecordHasAlreadyBeenDeletedException e) {
            return delegateInsert(entity);
        }
        assertEntityNotNullAndHasPrimaryKeyValue(entity);
        mergeEntity(entity, currentEntity);
        return delegateUpdate(currentEntity);
    }
    - - - - - - - - /

        「なければInsert、あればUpdate」します。
        外部Systemから夜間にDataを取り込む場合などに利用されます。


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Update after select.
     * 
     * @param entity Entity. This must contain primary-key value at least. (NotNull)
     * @return Updated count.
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasAlreadyBeenDeletedException
     */
    public int updateAfterSelect(LdBook entity) {
        assertEntityNotNullAndHasPrimaryKeyValue(entity);
        final LdBookCB cb = newMyConditionBean();
        cb.acceptPrimaryKeyMapString(entity.extractPrimaryKeyMapString());
        final LdBook currentEntity = selectEntityWithDeletedCheck(cb);
        mergeEntity(entity, currentEntity);
        return delegateUpdate(currentEntity);
    }
    - - - - - - - - /

        一旦Selectしてから更新をします。

          1. 引数のEntityのPrimaryKeyに該当するRecordを検索する。
          2. 検索結果のEntityに対して、引数のEntityでSetterの呼ばれた列の値を反映させる。
          3. 更新する。

        ＜引数のEntity＞
        PrimaryKeyの値＋更新したい列の値だけを格納していれば良いです。
          →newしたEntityにPrimaryKeyと更新したい列の値をSetすればOKです。

        ＜Update文のSet句＞
        Update文のSet句には、引数のEntityでSetterの呼ばれた列だけが指定されます(S2Dao-1.0.40より)。

        ＜排他制御＞
        引数のEntityにVersionNoやTimestampが指定されていない場合は、存在Checkで取得したDB上の値を
        そのままS2Daoに渡します。つまりその場合は、実質的な排他制御は行われません(0.x秒単位の排他制御は行われる)。
        排他制御を必要としない更新の場合は、このMethodを使うと便利です。
          → delegateUpdate()でVersionNoやTimestampを指定しないと更新に失敗する(S2Daoの仕様)。


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Insert or update after select-for-update.
     * {update: modified only}
     * 
     * @param entity Entity. This must contain primary-key value at least. (NotNull)
     * @return Updated count.
     */
    public int insertOrUpdateAfterSelectForUpdate(LdBook entity) {
        assertEntityNotNull(entity);
        if (!entity.hasPrimaryKeyValue()) {
            return delegateInsert(entity);
        }
        LdBook currentEntity = null;
        try {
            final LdBookCB cb = newMyConditionBean();
            cb.acceptPrimaryKeyMapString(entity.extractPrimaryKeyMapString());
            cb.lockForUpdate();
            currentEntity = selectEntityWithDeletedCheck(cb);
        } catch (dbflute.ldb.allcommon.exception.LdRecordHasAlreadyBeenDeletedException e) {
            return delegateInsert(entity);
        }
        assertEntityNotNullAndHasPrimaryKeyValue(entity);
        mergeEntity(entity, currentEntity);
        return delegateUpdate(entity);
    }
    - - - - - - - - /

        先述した insertOrUpdateAfterSelect() のForUpdate版です。


    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    /**
     * Update after select-for-update.
     * 
     * @param entity Entity. This must contain primary-key value at least. (NotNull)
     * @return Updated count.
     * @exception dbflute.ldb.allcommon.exception.LdRecordHasAlreadyBeenDeletedException
     */
    public int updateAfterSelectForUpdate(LdBook entity) {
        assertEntityNotNullAndHasPrimaryKeyValue(entity);
        final LdBookCB cb = newMyConditionBean();
        cb.acceptPrimaryKeyMapString(entity.extractPrimaryKeyMapString());
        cb.lockForUpdate();
        final LdBook currentEntity = selectEntityWithDeletedCheck(cb);
        mergeEntity(entity, currentEntity);
        return delegateUpdate(currentEntity);
    }
    - - - - - - - - /

        先述した updateAfterSelect() のForUpdate版です。




</pre>
</p>

<!-- document end -->
</html>
