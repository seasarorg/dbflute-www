<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head>
<title>Seasar - DI Container with AOP - </title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen" />
<link href="seasar_p.css" type="text/css" rel="stylesheet" media="print" />
<script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head>
<body onload="preload('ja')">
<table width="100%" border="0" cellspacing="0" cellpadding="0" align="left"><tr>
<td align="left" valign="top" width="780"><table width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr><td colspan="7"><img height="5" width="780" src="images/top01_b.gif" alt=""></td></tr>
<tr><td><img height="117" width="235" src="images/top02_b.gif" alt="Seasar"></td>
<td colspan="3"><img height="117" width="289" src="images/top03.gif" alt="DI Container with AOP"></td>
<td colspan="3"><img height="117" width="256" src="images/spacer.gif" alt=""></td>
</tr><tr><td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" height="30" width="110" border="0" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)"></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" height="30" width="113" border="0" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)"></a></td>
<td><img src="images/menu05_b_ja.gif" height="30" width="109" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></td>
<td><img height="30" width="34" src="images/menu06.gif" alt=""></td></tr><tr>
<td colspan="6"><img height="19" width="545" src="images/spacer.gif" alt=""></td></tr></table>
<table  width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr align="left" valign="top"><td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td><td width="740" class="main">
<!-- don't edit end -->
<!-- document start -->
<p>
<a href="index.html">to Top</a>
<p><b>
Sql2Entityの利用方法を記述します。
<p></b>
<pre>

* * * * * * * * * * * * * * * * * * * * * * * * 

このような開発が可能になります。

    1. {.sql}を作る。

    2. {.sql}から対応するEntityを自動生成する。

    3. DaoにMethodを定義して呼び出す。

* * * * * * * * * * * * * * * * * * * * * * * * 

// ======================================================================================================
//                                                                                             Sql2Entity
//                                                                                             ==========

DBFluteには、S2Daoの“外だしSQL”(SQLファイル)から、それに対応するEntityを自動生成する機能があります。
(そのEntityをDBFluteではCustomizeEntityと呼びます)


// -----------------------------------------------------
//                                      Sql2Entityの役割
//                                      ----------------

複雑なSQLはS2Daoの“外だしSQL”(SQLファイル)を利用します。(GroupByやSelect句での副問合せなど)
但しその場合、戻り値となるEntityを自分で作成しなければなりません。

それはとても面倒なので、作ったSQL文からEntityを自動生成して、その煩雑さを解消したいと考えます。


// -----------------------------------------------------
//                                  Sql2Entityの利用手順
//                                  --------------------

利用者は以下のような手順でSql2Entityを利用します。

    1. {.sql}をexdao(ExtendedDao)配下のDirectoryに作成。

         o その時のFile名は、S2Daoの規約に従うこと。
         o DaoはそのSQLが一番関連するであろうTableのDaoを選ぶこと。
         o SQLのCommentとして、以下のように生成するEntityのClass名を記述すること。

        ex) BookDao_selectBookCollectionStatistic.sql (CustomizeEntityの生成)
        /- - - - - - - - - - - - - - - - - - - - - - - -
        <b>--#BookCollectionStatistic#</b>
        select book.BOOK_ID
             , book.BOOK_NAME
             ...
        - - - - - - - - - -/

        ex) BookDao_selectBookCollectionStatistic.sql (ParameterBeanの生成)
        /- - - - - - - - - - - - - - - - - - - - - - - -
        <b>--!BookCollectionStatisticPmb!</b>
        <b>--!!java.math.BigDecimal bookId!!</b>
        <b>--!!String bookName!!</b>
        select book.BOOK_ID
             , book.BOOK_NAME
             ...
        - - - - - - - - - -/


    2. ./dbflute_[project]/sql2entity.bat(sh)を実行。

         o CommandのConsoleにLogが表示されるのでErrorが無いことを確認すること。


    3. 該当のDao-Interfaceに、その{.sql}を呼び出すMethodを追加。

        ex) BookDaoにBookCollectionStatisticを検索するMethodを定義
        /- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
        @OutsideSql
        <b>java.util.List&lt;BookCollectionStatistic&gt;
                    selectBookCollectionStatistic(BookCollectionStatisticPmb pmb);</b>
        - - - - - - - - - -/


// -----------------------------------------------------
//                                      Sql2Entityの処理
//                                      ----------------

Client-Directoryに用意されている「<b>sql2entity.bat</b>」を実行すると以下のような処理が実行されます。


    1. exdao(ExtendedDao)配下のDirectoryに存在する'.sql'ファイルを読み込む。

      ex) LdBookDao_selectBookCollectionStatistic.sql
      /- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
      <b>--#BookCollectionStatistic#</b>
      select book.BOOK_ID
           , book.BOOK_NAME
           , (select count(*) from COLLECTION where BOOK_ID = book.BOOK_ID) as COLLECTION_COUNT
        from BOOK book
       /*BEGIN*/where
         /*IF bookName != null*/book.BOOK_NAME like /*bookName*/'S2Dao' || '%'/*END*/
       /*END*/
       order by COLLECTION_COUNT desc
      ;
      - - - - - - - - - -/

      ※Sourceの出力先が「../src/main/java」の場合に限り「../src/main/resources」配下も対象とする。
        この場合は両方のexdao配下を探しにいく。


    2. '.sql'の中に'--#entityName#'と記載されているものを対象にSQLを実行する。

      SQLだけではどうしても自動生成するEntityName(Class名)は推測できませんので、
      '--#'と'#'の間に存在する文字列をEntityNameとし、その文字列が存在する'.sql'だけを対象として実行します。
      (全ての'.sql'が新たなEntityを必要とするわけではないので、EntityNameの有無でそれを区別します)

      '-- #'というように空白が一つ空いても構いません(２つ以上はダメ)。{MySQL対応}
        → MySQLの場合は、逆に空白が空いていないといけません。
           文法上「--」がCommentではなく「--(空白)」で初めてCommentと認識されるようです。
           (MySQL-5.0.x にて確認)

      DB2の場合は、SQLの前に'--##'が来るとErrorになる可能性があります。{CLI0637E:QUERY が見つかりません}
      その場合は、'--##'を最後に記述して実行してみて下さい。
      (SQLの終わりを表現する';'の前に'--##'を記述するようにして下さい)


    3. 結果のResultSetのMetaDataから、ColumnNameとColumnTypeを取得する。


    4. CustomizeEntityを自動生成する。



// -----------------------------------------------------
//                                       Daoでの設定方法
//                                       ---------------

{S2Dao-1.0.XX} (Java) & {S2Dao.net-1.0.X} (C#)

exdaoのどれかのDaoにMethodを追加します。
(どのDao(Table)に定義するかは、検索するSQLとTableの関連性から適切に(適当に)決めてください)

    ex) BookDaoにBookCollectionStatisticを検索するMethodを定義
    /- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    @OutsideSql
    <b>java.util.List&lt;BookCollectionStatistic&gt; selectBookCollectionStatistic(String bookName);</b>
    - - - - - - - - - -/

  Entity検索 → 戻り値の型にCustomizeEntityを指定する。
  List検索   → ListのElementの型(Generics)にCustomizeEntityを指定する。
  Array検索  → ArrayのElementの型にCustomizeEntityを指定する。

すると、S2Dao内部で検索結果がMappingされるEntityが、DaoのBean-Annotationに指定されたEntityではなく、
戻り値に指定されたCustomizeEntityに差し替えられます。(上記の例だと「LdBookCollectionStatistic」)


    ※OutsideSql-Annotationは外だしSQLのときに「できるだけ」付けておいた方がいいです。
      SpellMissやDeployMissなどで{.sql}が見つけれらなかった場合に
      専用のMessageを積んだExceptionが発生されるようになります。
      (これを付けないとS2DaoのDefaultの挙動で誤動作して原因がわかりにくくなります)
      (ごめんなさい、JDK-1.4にはありません)


_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
本来、S2Dao-1.0.XXは「1Daoに付き1Entity」なのですが、DBFluteがS2Daoを拡張して上記の利用方法を可能としました。
(拡張は、DaoMetaDataImplを継承拡張しているだけなので、利用するS2Daoのjarは公式Siteから手に入るものでOKです)

制限としては、JDK-1.4を利用される場合はListのElement指定ができないため、List検索ではこの方式は利用できません。
その場合(JDK-1.4)は、Arrayの戻り値を使うようにして下さい


#
# 追記(2007/08/24)：
# S2Daoでも独自DTOを戻り地にすることが可能になりました。
# が、特にDBFluteでの利用は何も変わりません。
#
_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/



// -----------------------------------------------------
//                                      Sql2Entityの設定
//                                      ----------------

ここまでは、'build.properties'にSql2Entityに関するPropertyを特に設定していませんが、
幾つか挙動を変えるためのPropertyが存在しています。

* * * * * * * * * * * * * * * * * * * * * * * * * * *
ほとんどの場合は、デフォルトの設定で問題ありません。

Projectの規約などで、どうしても避けられない
Directory構成などの縛りが発生したときに
以下の設定が必要になります。
* * * * * * * * * * * * * * * * * * * * * * * * * * *


    ex) build.properties - 'sql2EntityDefinitionMap'
    /- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    torque.sql2EntityDefinitionMap = map:{ \
             ; sqlDirectory = ./playsql/testsql \
             ; isPlainEntity = true \
             ; outputDirectory = ./output/src \
             ; packageString = dbflute.ldb \
         }
    - - - - - - - - - -/

  sqlDirectory    ： '.sql'を探すDirectoryを指定することができます。
  isPlainEntity   ： trueの場合、DBFluteに依存しないPlainなEntityを作成します。
  outputDirectory ： 自動生成Classを出力するDirectoryです。(このDirectory以下にPackage構成が展開されます)
  packageString   ： 自動生成ClassのPackageです。

_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
DBFluteは特に利用していないがS2Daoを利用していてSql2Entityの機能を利用したいという方は、
このisPlainEntityを必ず true にしてご利用下さい。

  ※ちなみにそのような方は、<a href="./how-to-setup.html">How to Setup</a> のClient-Directoryの選択にて、
    'otherORMapper'を選ぶと環境構築が楽になります。
_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/


// -----------------------------------------------------
//                                      PrimaryKeyの設定
//                                      ----------------

PrimaryKeyを設定することができます。

PrimaryKeyを設定するとEntityにてPrimaryKeyを識別することができ、extractPrimaryKeyMapString()や
hasPrimaryKeyValue()などのMethodを利用することができます。
(設定されていないと、全てのColumnの複合PrimaryKeyと判断される)
また、equals()がPrimaryKeyを基準に判定されるようになります。

  ※無茶苦茶便利なのかと言われると、そこまでは...って感じではありますが...
    やっておくと便利なときもあるので、ハッキリとわかる時は設定しておくことをお奨めします。


該当の“外だしSQL”にて得られる結果をUniqueに識別するColumnを指定します。

    ex) LdBookDao.selectBookCollectionStatistic()の'.sql'
    /- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    <b>--#BookCollectionStatistic#</b>
    <b>--*BOOK_ID*</b>
    select book.BOOK_ID
         , book.BOOK_NAME
         , (select count(*) from COLLECTION where BOOK_ID = book.BOOK_ID) as COLLECTION_COUNT
      from BOOK book
     /*BEGIN*/where
       /*IF bookName != null*/book.BOOK_NAME like /*bookName*/'S2Dao' || '%'/*END*/
     /*END*/
     order by COLLECTION_COUNT desc
    ;
    - - - - - - - - - -/

'--*'と'*'で囲まれた文字列がPrimaryKeyとなります。
PrimaryKeyが複数存在する場合は、',' or ';' or '/' or '\t'で区切って記載します。

    ex) --*BOOK_ID, COLLECTION_ID*


// -----------------------------------------------------
//                                   ParameterBeanの生成
//                                   -------------------

SQLへ渡すParameter(引数)の数が多くなりがちです。
また、Java版だと引数が2つ以上の場合はARGS-Annotationを設定してなければならないのでちょっと面倒です。

そこで、DBFluteではSql2Entityを生成するのと同時に、SQLへのParameterBean(引数DTO)を生成することができます。

    ex) LdBookDao.selectBookCollectionStatistic()の'.sql'
    /- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    <b>--#BookCollectionStatistic#</b>
    <b>--*BOOK_ID*</b>
    <b>
    --!BookCollectionStatisticPmb!
    --!!java.math.BigDecimal bookId!!
    --!!String bookName!!
    </b>
    select book.BOOK_ID
         , book.BOOK_NAME
         , (select count(*) from COLLECTION where BOOK_ID = book.BOOK_ID) as COLLECTION_COUNT
      from BOOK book
     /*BEGIN*/where
       /*IF pmb.bookId != null*/book.BOOK_ID = /*pmb.bookId*/1/*END*/
       /*IF pmb.bookName != null*/and book.BOOK_NAME like /*pmb.bookName*/'S2Dao' || '%'/*END*/
      /*END*/
     order by COLLECTION_COUNT desc
    ;
    - - - - - - - - - -/

{Class}
'--!'と'!'の間に存在する文字列をClassNameとします。
指定するClassNameは、ProjectPrefixを除いたClassNameです。
空白を入れて'extends Xxx'と続けて指定することにより、継承Classを指定することができます。
(C#版においても'extends'と記述して下さい。内部で':'に置き換えます)

{Property}
'--!!'と'!!'の間に存在する文字列をPropertyとします。
型と名称を間に空白を入れて指定します。
Propertyは複数指定可能です。

{OutputPackage}
GenerationGapにて、それぞれ 'bsdao.pmbean' と 'exdao.pmbean' に出力されます。

{Other}
CustomizeEntity(--#EntityName#)を指定していなくても、ParameterBean(--!ParameterBean!)を指定していれば、
Sql2Entityの対象SQLと判断され実行されます。
戻り値のEntityはDomainEntityで、ParameterBeanだけを利用したい場合も特に問題ありません。

全く同じ ParameterBean を別のSQLで利用した場合は、どちらか片方に記述するだけでOKです。


// -----------------------------------------------------
//                 ParameterBeanとSimplePagingBeanの連携
//                 -------------------------------------

外だしSQLでParameterBeanを利用する時は、Pagingと併用することが多いです。(検索条件の多いPaging検索画面などにおいて)
その場合はClassNameを以下のように設定することで、SimplePagingBeanを継承したParameterBeanを作成することができます。

    ex) <b>--!BookCollectionStatisticPmb extends SPB!</b>

このように記述すると、'SPB'という文字列を内部で SimplePagingBean に置き換えます。

    ex) 呼び出し側のProgram記述例
    /- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    final LdBookCollectionStatisticPmb pmb = new LdBookCollectionStatisticPmb();
    pmb.fetchFirst(3);// pageSizeは'3'
    pmb.fetchPage(2);// pageNumberは'2'
    pmb.setBookName("S2Dao");
    java.util.List&lt;LdBookCollectionStatistic&gt; ls = dao.selectBookCollectionStatistic(pmb);
    - - - - - - - - - -/
    ※Dao-Methodの引数が1つになるため、Java版のS2Daoで面倒な ARGS-Annotation が不要になります


外だしSQLのPagingについては <a href="./tips-paging.html">Tips: Paging</a> をご覧下さい。


</pre>
</p>

<!-- document end -->
</html>
