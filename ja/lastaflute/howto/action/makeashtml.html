<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<meta name="keywords" content="DBFlute,LastaFlute,Java,Lean Startup,Incremental Development" />
	<link rel="stylesheet" type="text/css" href="../../../../css/lasub.css" />
	<!--[if IE 6.0]>
		<link rel="stylesheet" type="text/css" href="../../../../css/cb/sub.css" />
	<![endif]--> 
	<title>Actionの作り方 (HTMLスタイル) | LastaFlute</title>
</head>
<body>
<div id="container" class="ct-default">

<div id="mainbar">
<div id="header">
	<div class="navi-upper"><a href="../../../../ja/sitemap.html">SiteMap</a>|<a href="http://d.hatena.ne.jp/jflute/">Author's Blog</a></div>
	<div class="navi-main">
	<ul>
		<li class="hd-introduction"><a href="../../../../ja/introduction/index.html"><img src="../../../../image/parts/navi/link-intro.png" alt="Introduction" width="75" height="32" /></a></li>
		<li class="hd-tutorial"><a href="../../../../ja/tutorial/index.html"><img src="../../../../image/parts/navi/link-tuto.png" alt="Tutorial" width="56" height="24" /></a>
			<ul>
				<li class="hd-architect"><a href="../../../../ja/tutorial/architect.html"><img src="../../../../image/parts/navi/link-arch.png" alt="for Architect" width="80" height="24" /></a></li>
				<li class="hd-developer"><a href="../../../../ja/tutorial/developer.html"><img src="../../../../image/parts/navi/link-dev.png" alt="for Developer" width="87" height="24" /></a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../ja/environment/index.html"><img src="../../../../image/parts/navi/link-env.png" alt="Environment" width="84" height="25" /></a>
			<ul>
				<li class="hd-install"><a href="../../../../ja/environment/setup/index.html"><img src="../../../../image/parts/navi/link-setup.png" alt="Setup" width="42" height="24" /></a></li>
				<li class="hd-upgrade"><a href="../../../../ja/environment/upgrade/index.html"><img src="../../../../image/parts/navi/link-upgrade.png" alt="Upgrade" width="61" height="25" /></a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../ja/manual/index.html"><img src="../../../../image/parts/navi/link-manual.png" alt="Manual" width="62" height="25" /></a></li>
	</ul>
	</div>
</div>

<div id="content">
	<h1>Actionの作り方 (HTMLスタイル)</h1>
	<div class="relatedpage"><a href="../../index.html">LastaFluteトップページ</a></div>
	<div class="relatedpage"><a href="../../tutorial/laimpl.html">LastaFluteの実装チュートリアル</a></div>
	<div class="relatedpage"><a href="./index.html">LastaFluteのAction</a></div>
	<ul class="indexlist">
		<li><a href="#flow">実装の流れ</a>
			<ul>
				<li><a href="#precon">ちょっと前提</a></li>
				<li><a href="#handson">ハンズオンで Action を作ってみよう！</a></li>
				<li><a href="#rough">まずはラフスケッチ実装</a></li>
			</ul>
		</li>
		<li><a href="#designurl">URLを決める</a></li>
		<li><a href="#makeaction">Actionクラスを作る</a>
			<ul>
				<li><a href="#actionname">Actionの名前を決める</a></li>
				<li><a href="#pkglocation">Actionのパッケージ(配置場所)を決める</a></li>
				<li><a href="#actuallymakeaction">実際に作る</a></li>
			</ul>
		</li>
		<li><a href="#prepareexecute">Executeメソッドを準備</a>
			<ul>
				<li><a href="#extendsbase">Baseクラスを継承</a></li>
				<li><a href="#executedef">Executeメソッドを定義</a></li>
			</ul>
		</li>
		<li><a href="#makeform">Formを作る</a>
			<ul>
				<li><a href="#formdef">Formクラスを定義</a></li>
				<li><a href="#implform">Formの実装</a></li>
			</ul>
		</li>
		<li><a href="#makehtml">HTMLテンプレートを作る</a>
			<ul>
				<li><a href="#htmlname">HTMLテンプレートのファイル名</a></li>
				<li><a href="#htmldir">HTMLテンプレートのディレクトリ</a></li>
				<li><a href="#htmlfreegen">FreeGenを叩いてパス自動生成</a></li>
				<li><a href="#htmlfreegen">JSPの実装...はさておいて</a></li>
			</ul>
		</li>
		<li><a href="#implexecute">Executeメソッドを実装</a>
			<ul>
				<li><a href="#returnfornow">ひとまずreturnを書いておく</a></li>
				<li><a href="#validate">validate()を呼ぶ</a></li>
				<li><a href="#dbflute">DBFluteを使う</a></li>
				<li><a href="#dispbean">表示データのBeanを作る</a></li>
				<li><a href="#dispdata">表示データをResponseに設定</a></li>
			</ul>
		</li>
		<li><a href="#roughfinished">ラフスケッチできた</a>
			<ul>
				<li><a href="#firstboot">Bootしてアクセスしてみましょう</a></li>
				<li><a href="#tomethod">ちょいっとリファクタリング</a></li>
			</ul>
		</li>
		<li><a href="#adjustment">いろいろ調整しながら実装</a></li>
		<li><a href="#littletips">ちょこっとTips</a>
			<ul>
				<li><a href="#supermethod">スーパークラスのメソッド、何が使える？</a></li>
			</ul>
		</li>
		<li><a href="#office">事務連絡</a></li>
	</ul>

	<h2 id="flow">実装の流れ</h2>
	<h3 id="precon">ちょっと前提</h3>
	<p>
		ここでは、docksidestage.org というドメイン、つまりパッケージは <em class="mark">org.docksidestage</em>
		を想定し、<em class="mark">harbor</em> というアプリ名であることを想定して説明していきます。
	</p>
	<h3 id="handson">ハンズオンで Action を作ってみよう！</h3>
	<p>
		LastaFluteでの実装のやり方を学んでいる最中であれば、まずは、Exampleプロジェクト harbor
		で、実際にクラスを作りながらやっていってもよいでしょう。コードを真似て書きながら(コピーでもOK)、画面を作っていくと流れとコツがわかってくるかと思います。
		<span class="frm">(それができるようにドキュメントを作っています)</span>
	</p>
	<p>
		実装チュートリアルに載っている環境が整っていることが前提です。例えば、Example を clone した後に、ReplaceSchema を叩き忘れていませんか？
	</p>
	<h3 id="rough">まずはラフスケッチ実装</h3>
	<p>
		一行一行、しっかり書いていくのではなく、まずは流れを実装して、全体像を構築してから細かいところを固めていくというスタイルをオススメしています。
		最初の一ターン目はラフスケッチです。わからないことがあったら保留して次に進み、全体像を把握できる状態になってからつまづいたところを解決していきましょう。
	</p>
	<ol>
		<li>URLを決める</li>
		<li>Actionクラスを作る</li>
		<li>Executeメソッドを準備</li>
		<li>Formを作る</li>
		<li>HTMLテンプレートを作る</li>
		<li>Executeメソッドを実装</li>
		<li>いろいろ調整しながら実装</li>
	</ol>

	<h2 id="designurl">URLを決める</h2>
	<p>
		まずは、URLを決めましょう。 
	</p>
	<p>
		ここでは <em class="mark">/sea/land/3?pay=HAN</em> (/sea/land/[商品ID]?pay=[支払方法]) というGETリクエストの対応する Action を作ることにしましょう。
	</p>
	<p>
		/3 の部分はURLパラメーターで商品IDと想定し、<em class="mark">ログイン会員(自分)とフォローしている会員の、指定された商品に対応する購入一覧</em>
		を表示するとしましょう。もし、payが指定されていたら、指定された方法で支払された購入に絞るとします。<span class="frm">(maihamadb を参考に、よくわからなければ後で)</span>
	</p>
	<div class="relatedpage"><a href="../../../manual/reference/example/exampledb.html">MaihamaDB</a></div>

	<h2 id="makeaction">Actionクラスを作る</h2>
	<h3 id="actionname">Actionの名前を決める</h3>
	<p>
		/3 はURLパラメーターとするならば、Actionを識別する部分が /sea/land/ となり、
	</p>
	<ul>
		<li>A. <em class="mark">Sea</em>Action#<em class="mark">land</em>()</li>
		<li>B. <em class="mark">SeaLand</em>Action#index()</li>
	</ul>
	<p>
		の、どちらかとなります。<em class="keyword">(規約)</em>
	</p>
	<div class="relatedpage"><a href="./index.html#urlmapping">LastaFluteのAction - URL Mapping</a></div>
	<p>
		基本的には、一つの画面に付き、一つのActionがオススメです。ですが、業務規模などの都合で微調整してもよいでしょう。
		<span class="frm">(とりあえず漠然と決めて、あとでやっぱりこっちだった、となればリファクタリングすればOKです。変更してもURLには影響しません)</span>
	</p>
	<p>
		ここでは、landという画面があると想定して、<em class="mark">SeaLandAction#index()</em> を作りましょう。
	</p>
	<h3 id="pkglocation">Actionのパッケージ(配置場所)を決める</h3>
	<p>
		SeaLandAction であれば...
	</p>
	<ul>
		<li>A. ...app.web.SeaLandAction</li>
		<li>B. ...app.web.<em class="mark">sea</em>.SeaLandAction</li>
		<li>C. ...app.web.<em class="mark">sea.land</em>.SeaLandAction</li>
	</ul>
	<p>
		のどれかになります。<em class="keyword">(規約)</em>
	</p>
	<div class="relatedpage"><a href="./index.html#pkglocation">LastaFluteのAction - Action Package</a></div>
	<p>
		web直下に置くのは、よほどのメジャー感のあるものなので、基本的には B, C となるでしょう。
		seaの仲間がすごく多いことが想定される場合は C ですが、まずは B にしておいて、後から移動してもよいでしょう。
		<span class="frm">(あとでパッケージを移動しても、URLやプログラムに影響はありません)</span>
	</p>
	<p>
		ここでは、...app.web.<em class="mark">sea</em> に置くことにしましょう。
	</p>
	<h3 id="actuallymakeaction">実際に作る</h3>
	<p>
		実際に org.docksidestage.app.web.sea.SeaLandAction にクラスを作ってみましょう。
	</p>
<pre><span class="codetitle">e.g. Action class location @Package</span><code>
src/main/java
 |-org.docksidestage
 |  |-app
 |  |  |-logic
 |  |  |-web
 |  |  |  |-<span class="subpoint">sea</span>
 |  |  |  |  |-<span class="point">SeaLandAction.java</span>
 |  |  |  |-<span class="abbreviation">...</span>
 |  |  |-<span class="abbreviation">...</span>
 |  |-bizfw
 |  |-dbflute
 |  |-<span class="abbreviation">...</span>
</code></pre>

	<h2 id="prepareexecute">Executeメソッドを準備</h2>
	<h3 id="extendsbase">Baseクラスを継承</h3>
	<p>
		まずは、作成したActionにて、そのアプリのBaseクラスを継承しましょう。アプリ名が harbor
		であれば、	<em class="mark">HarborBaseAction</em> を継承します。<span class="frm">(そのアプリのBaseActionが用意されているはずです)</span>
	</p>
<pre><span class="codetitle">e.g. Action class extends Base class @Java</span><code>
<span class="comment">/**
 * @author yourname
 */</span>
<span class="keyword">public class</span> SeaLandAction <span class="subpoint">extends</span> <span class="point">HarborBaseAction</span> {
}
</code></pre>
	<h3 id="executedef">Executeメソッドを定義</h3>
	<p>
		ここでは、HTMLスタイルの Execute メソッド <em class="mark">index()</em>
		を作ってみましょう。
	</p>
	<p>
		Executeアノテーションを付けて戻り値は HtmlResponse,
		そして、URLパラメーター /3 を受け取る引数を最初に定義して、GETパラメーターを受け取る Form を最後の引数に定義します。<em class="keyword">(規約)</em>
	</p>
	<div class="relatedpage"><a href="./index.html#makeaction">LastaFluteのAction - make Action Class</a></div>
<pre><span class="codetitle">e.g. Action class extends Base class @Java</span><code>
<span class="comment">/**
 * @author yourname
 */</span>
<span class="keyword">public class</span> SeaLandAction <span class="keyword">extends</span> HarborBaseAction {

    @Execute
    <span class="keyword">public</span> <span class="subpoint">HtmlResponse</span> index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    	<span class="comment">// コンパイルエラーです！</span>
    	<span class="comment">// この後、Formを作って戻り値を指定しますので、ちょっとそのままで。</span>
    }
}
</code></pre>
	<p>
		もし、URLパラメーターの /3 が非必須の要素であれば、productId の型を OptionalThing&lt;Integer&gt;
		にします。省略されたときは empty になります。そもそも、URLパラメーターもFormパラメーターもないのであれば、引数なしでOKです。
	</p>

	<h2 id="makeform">Formを作る</h2>
	<h3 id="formdef">Formクラスを定義</h3>
	<p>
		SeaLandForm は定義してみましたが、まだ存在しないのでコンパイルエラーです。
	</p>
	<p>
		<em class="keyword">Formのクラス名は Form で終わる</em> 必要があります<em class="keyword">(規約)</em>。その前の名前は任意ですが、Actionとイメージの近い名前がオススメです。
		ここでは、<em class="mark">SeaLandForm</em> という名前で作りましょう。
	</p>
	<p>
		パッケージ(置き場所)は、Actionクラスと同じ (つまり、Actionの隣に置く) がオススメです。
	</p>
<pre><span class="codetitle">e.g. Form class location @Directory</span><code>
src/main/java
 |-org.docksidestage
 |  |-app
 |  |  |-logic
 |  |  |-web
 |  |  |  |-sea
 |  |  |  |  |-SeaLandAction.java
 |  |  |  |  |-<span class="point">SeaLandForm.java</span>
 |  |  |  |-<span class="abbreviation">...</span>
 |  |  |-<span class="abbreviation">...</span>
 |  |-bizfw
 |  |-dbflute
 |  |-<span class="abbreviation">...</span>
</code></pre>
	<h3 id="implform">Formの実装</h3>
	<p>
		publicフィールドで受け取るパラメーターのプロパティを定義します。フリー入力項目でなければ、Stringではなく、Integer や LocalDate
		や CDef (区分値) など、ネイティヴな型で宣言してOKです。
		<span class="frm">(変換できない値だったら、それはシステム上のミス、もしくは、いたずらということで 400 になる)</span>
	</p>
	<p>
		ここでは、pay=HANというGETパラメーターに対応して、payプロパティを定義しましょう。
		商品ステータスの区分値なので、CDef 型で宣言します。
	</p>
<pre><span class="codetitle">e.g. Form class @Java</span><code>
<span class="comment">/**
 * @author yourname
 */</span>
<span class="keyword">public class</span> SeaLandForm {

    <span class="keyword">public</span> <span class="point">CDef.PaymentMethod</span> <span class="attribute">pay</span>;
}
</code></pre>
	<p>
		もし、バリデーションを行うなら、Validatorアノテーションを付けます。
	</p>
	<dl class="longvaluemainlist">
		<dt>必須チェック</dt><dd>@Required <span class="frm">(String, Integerなんでも使える)</span></dd>
		<dt>文字列の最大長</dt><dd>@Length</dd>
		<dt>数値の最大値</dt><dd>@Max</dd>
		<dt>などなど</dt><dd>いろいろ</dd>
	</dl>
	<p>
		ここでは、payプロパティを必須にしてしまいましょう。<span class="frm">(何も付けないと説明しづらいので...)</span>
	</p>
<pre><span class="codetitle">e.g. Form class @Java</span><code>
<span class="comment">/**
 * @author yourname
 */</span>
<span class="keyword">public class</span> SeaLandForm {

    <span class="point">@Required</span>
    <span class="keyword">public</span> CDef.PaymentMethod <span class="attribute">pay</span>;
}
</code></pre>

	<h2 id="makehtml">HTMLテンプレートを作る</h2>
	<p>
		Actionの実装の前に、HTMLテンプレートのファイルを作って、自動生成だけやっておきましょう。
	</p>
	<p>
		ここでは、JSPを想定します。<span class="frm">(将来、提供されるメインのテンプレートが変わるかもしれません)</span>
	</p>
	<h3 id="htmlname">HTMLテンプレートのファイル名</h3>
	<p>
		関連するActionクラスを識別できる名前にします。<em class="keyword">(規約)</em>
	</p>
	<p>
		SeaLandAction であれば、sea_land.jsp になります。
		la:form で action 属性を省略したとき、/sea/land/[submitされたボタン名] にsubmitされます。
		<span class="frm">(省略しなければ、名前は任意になりますが、合わせておくのがオススメです)</span>
	</p>
	<p>
		ここでは、<em class="mark">sea_land.jsp</em> にします。
	</p>
	<h3 id="htmldir">HTMLテンプレートのディレクトリ</h3>
	<p>
		JSPは、src/main/webapp/WEB-INF/view の下に作成します。<em class="keyword">(規約)</em>
	</p>
	<p>
		そこからのディレクトリ構成は、Actionクラスと同じで、sea_land.jsp なら、sea ディレクトリか sea/land ディレクトリの下に配置します。
		<em class="keyword">(規約)</em>
	</p>
	<p>
		ここでは、src/main/webapp/WEB-INF/view/<em class="mark">sea</em> ディレクトリにします。
	</p>
	<h3 id="htmlfreegen">FreeGenを叩いてパス自動生成</h3>
	<p>
		manageタスク (DBFluteクライアントの manage.bat|sh) の 12 (freegen) を叩いて、FreeGen を実行すると、そのHTMLテンプレートに対応するパス定義が自動生成されます。
		ここでは <em class="mark">HarborHtmlPath</em> に <em class="mark">path_Sea_SeaLandJsp</em> というパス定義が追加されるでしょう。
	</p>
<pre><span class="codetitle">e.g. execute FreeGen @Command</span><code>
<span class="abbreviation">...</span>$ sh <span class="point">manage.sh</span>

<span class="comment">// メニューが表示されるので、12 (freegen) を入力してEnter</span>
<span class="comment">// Windowsなら manage.bat, Eclipseからでも直接叩ける</span>
</code></pre>
	<h3 id="htmlfreegen">JSPの実装...はさておいて</h3>
	<p>
		まだ、ラフスケッチ中なので、中身はシンプルな状態で。この時点では真っ白でもOKです。
		ここでは、<em class="mark">何も表示されないと悲しい</em> ので、一覧を表示するHTMLだけちょこっと書いておきましょう。
	</p>
<pre><span class="codetitle">e.g. execute FreeGen @Command</span><code>
&lt;c:import url="${viewPrefix}/common/default_layout.jsp"&gt;
&lt;c:param name="contents"&gt;
&lt;!-- &lt;main&gt; start main content --&gt;
&lt;div class="contents"&gt;
    &lt;h2 class="pg-content-title"&gt;&lt;la:caption key="labels.purchase.list.title"/>&lt;/h2&gt;
    &lt;section class="purchase-result-box"&gt;
        &lt;p&gt;
            Payment Method: ${f:h(pay)} &lt;la:errors property="pay"/&gt;
        &lt;/p&gt;
        &lt;h3 class="pg-content-title-second"&gt;Search Results&lt;/h3&gt;
        &lt;table class="purchase-list-tbl"&gt;
            &lt;thead&gt;
                &lt;tr&gt;
                    &lt;th&gt;ID&lt;/th&gt;
                    &lt;th&gt;Member Name&lt;/th&gt;
                    &lt;th&gt;Product Name&lt;/th&gt;
                    &lt;th&gt;Product Handle Code&lt;/th&gt;
                    &lt;th&gt;Purchase Date&lt;/th&gt;
                    &lt;th&gt;Purchase Price&lt;/th&gt;
                &lt;/tr&gt;
            &lt;/thead&gt;
            &lt;tbody&gt;
                &lt;c:forEach var="bean" items="${beans}"&gt;
                &lt;tr&gt;
                    &lt;td&gt;${f:h(bean.purchaseId)}&lt;/td&gt;
                    &lt;td&gt;${f:h(bean.memberName)}&lt;/td&gt;
                    &lt;td&gt;${f:h(bean.productName)}&lt;/td&gt;
                    &lt;td&gt;${f:h(bean.productHandleCode)}&lt;/td&gt;
                    &lt;td&gt;${f:h(bean.purchaseDate)}&lt;/td&gt;
                    &lt;td&gt;${f:h(bean.purchasePrice)}&lt;/td&gt;
                &lt;/tr&gt;
                &lt;/c:forEach&gt;
            &lt;/tbody&gt;
        &lt;/table&gt;
    &lt;/section&gt;
&lt;/div&gt;
&lt;!-- &lt;/main&gt; end of main content --&gt;
&lt;/c:param&gt;
&lt;/c:import&gt;
</code></pre>
	<p>
		※将来、JSP ではなく Thymeleaf になる可能性があります。
	</p>

	<h2 id="implexecute">Executeメソッドを実装</h2>
	<h3 id="returnfornow">ひとまずreturnを書いておく</h3>
	<p>
		returnは後であれこあカスタマイズするかもしれませんが、コンパイルエラーのまま実装するのはつらいので、とりあえず解決しておきます。
	</p>
	<p>
		asHtml([自動生成されたHTMLテンプレートのパス定義]) を return します。
	</p>
<pre><span class="codetitle">e.g. return HtmlResponse as HTML template @Java</span><code>
@Execute
<span class="keyword">public</span> <span class="subpoint">HtmlResponse</span> index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="keyword">return</span> <span class="point">asHtml</span>(<span class="attribute">path_Sea_SeaLandJsp</span>); 
}
</code></pre>
	<p>
		もし、別の Action へのリダイレクトなら、redirect([リダイレクト先のAction]) を return します。
	</p>
<pre><span class="codetitle">e.g. return HtmlResponse as redirect @Java</span><code>
@Execute
<span class="keyword">public</span> <span class="subpoint">HtmlResponse</span> index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="keyword">return</span> <span class="point">redirect</span>(IksAmbaAction.class); 
}
</code></pre>
	<h3 id="validate">validate()を呼ぶ</h3>
	<p>
		FormにValidatorアノテーションを一つでも付けているなら、validate() を呼ぶ必要があります。
	</p>
<pre><span class="codetitle">e.g. validate() in Action class @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="point">validate</span>(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {}, () -&gt; {
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
    });
    <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>); 
}
</code></pre>
	<p>
		Eclipseであれば、秘伝の EditorTemplate が設定されていれば、魔法のように補完できます。
	</p>
	<div class="relatedpage"><a href="../../../tutorial/onjava8.html#triclipse">DBFlute on Java8 - 裏技あります</a></div>
	<p>
		相関バリデーションやDBを使ったバリデーションなど、アノテーションでは実現できないものは、第二引数の Lambda の中で実装します。
		まあ、いったん長そうであれば、todoコメントいれて保留しましょう。
	</p>
	<h3 id="dbflute">DBFluteを使う</h3>
	<p>
		DBFluteを使って検索・更新などを行うのであれば...基点テーブルの Behavior を DI しましょう。
	</p>
	<p>
		ここでは、購入の一覧でしたから、基点テーブルは <em class="mark">PURCHASE</em> です。
	</p>
<pre><span class="codetitle">e.g. DBFlute Behavior's DI @Java</span><code>
@Resource
<span class="keyword">private</span> <span class="point">PurchaseBhv</span> <span class="attribute">purchaseBhv</span>;

@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="abbreviation">...</span>
}
</code></pre>
	<p>
		そして、ConditionBean で検索しましょう。
	</p>
	<div class="relatedpage"><a href="../../../tutorial/onjava8.html">DBFlute on Java8</a></div>
<pre><span class="codetitle">e.g. select by ConditionBean @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    validate(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {}, () -&gt; {
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
    });
    Integer <span class="localvar">userId</span> = <span class="subpoint">getUserBean()</span>.get().getUserId();
    ListResultBean&lt;Purchase&gt; <span class="localvar">purchaseList</span> = <span class="attribute">purchaseBhv</span>.<span class="point">selectList</span>(<span class="localvar">cb</span> -&gt; {
        <span class="localvar">cb</span>.setupSelect_Member();
        <span class="localvar">cb</span>.setupSelect_Product();
        <span class="localvar">cb</span>.query().setProductId_Equal(<span class="localvar">productId</span>);
        <span class="localvar">cb</span>.orScopeQuery(<span class="localvar">orCB</span> -> {
            <span class="localvar">orCB</span>.query().setMemberId_Equal(<span class="localvar">userId</span>);
            <span class="localvar">orCB</span>.query().queryMember().existsMemberFollowingByYourMemberId(<span class="localvar">followingCB</span> -> {
                <span class="localvar">followingCB</span>.query().setMyMemberId_Equal(<span class="localvar">userId</span>);
            });
        });
        <span class="localvar">cb</span>.query().existsPurchasePayment(<span class="localvar">paymentCB</span> -&gt; {
            <span class="localvar">paymentCB</span>.query().setPaymentMethodCode_Equal_AsPaymentMethod(form.<span class="attribute">pay</span>);
        });
        <span class="localvar">cb</span>.query().addOrderBy_PurchaseDatetime_Desc();
    });
    <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>); 
}
</code></pre>
	<p>
		<span class="frm">※実際、商品IDが固定なので、商品は単独データ取得してリストでは要らないはずですが、簡略化しています</span>
	</p>
	<p>
		ログインしているユーザーの情報は、getUserBean() で取得できます。
		ここでは、ログインしていることが前提なので、戻り値の OptionalThing は問答無用で get() してしまいます。
	</p>
	<p>
		ちなみに、文字列をnullと空文字で分岐させる場合、isEmpty(), isNotEmpty()
		というメソッドが用意されています。必須ではない検索条件のときに利用するとよいでしょう。
	</p>
<pre><span class="codetitle">e.g. isEmpty(), isNotEmpty() @Java</span><code>
<span class="keyword">if</span> (<span class="point">isNotEmpty</span>(<span class="localvar">form</span>.<span class="attribute">name</span>)) {
    <span class="localvar">cb</span>.query().setMemberName_LikeSearch(<span class="localvar">form</span>.<span class="attribute">name</span>, <span class="localvar">op</span> -&gt; <span class="localvar">op</span>.likePrefix());
}
</code></pre>
	<p>
		まだ、ラフスケッチ中なので、完璧な実装じゃなくてもOKです。とりあえずなんか検索できれば。
	</p>
	<h3 id="dispbean">表示データのBeanを作る</h3>
	<p>
		HTMLテンプレートへ渡すための Bean クラスを作成し、検索されたデータを詰め替えます。
	</p>
	<p>
		ここに関しては、Lastaだからどうだってのはありませんが、習慣として Bean という名前のクラスをActionの隣に作っています。
		ここでは、<em class="mark">SeaLandRowBean</em> というクラスを作りましょう。
	</p>
<pre><span class="codetitle">e.g. Bean class location @Directory</span><code>
src/main/java
 |-org.docksidestage
 |  |-app
 |  |  |-logic
 |  |  |-web
 |  |  |  |-sea
 |  |  |  |  |-SeaLandAction.java
 |  |  |  |  |-SeaLandForm.java
 |  |  |  |  |-<span class="point">SeaLandRowBean.java</span>
 |  |  |  |-<span class="abbreviation">...</span>
 |  |  |-<span class="abbreviation">...</span>
 |  |-bizfw
 |  |-dbflute
 |  |-<span class="abbreviation">...</span>
</code></pre>
<pre><span class="codetitle">e.g. properties for display in Bean class @Java</span><code>
<span class="comment">/**
 * @author yourname
 */</span>
<span class="keyword">public class</span> SeaLandRowBean {

    <span class="keyword">public</span> Long <span class="attribute">purchaseId</span>;
    <span class="keyword">public</span> String <span class="attribute">memberName</span>;
    <span class="keyword">public</span> String <span class="attribute">productName</span>;
    <span class="keyword">public</span> String <span class="attribute">productHandleCode</span>;
    <span class="keyword">public</span> String <span class="attribute">purchaseDate</span>;
    <span class="keyword">public</span> Integer <span class="attribute">purchasePrice</span>;
}
</code></pre>
	<p>
		ここも、ネイティヴ型でよければ、Integer や LocalDate などの型で定義してしまいます。
		日付に関しては、デフォルトのフォーマットだと都合が悪いかもしれないので、String にしておいて変換時に整えるとよいでしょう。
	</p>
<pre><span class="codetitle">e.g. renderWith() in Action class @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    validate(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {}, () -&gt; {
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
    });
    ListResultBean&lt;Purchase&gt; <span class="localvar">purchaseList</span> = <span class="attribute">purchaseBhv</span>.selectList(cb -&gt; {
        <span class="abbreviation">...</span>
    });
    List&lt;SeaLandRowBean&gt; <span class="localvar">beans</span> = <span class="localvar">purchaseList</span>.<span class="point">mappingList</span>(<span class="localvar">purchase</span> -&gt; {
        SeaLandRowBean <span class="localvar">bean</span> = <span class="keyword">new</span> SeaLandRowBean();
        <span class="localvar">bean</span>.<span class="attribute">purchaseId</span> = <span class="localvar">purchase</span>.getPurchaseId();
        <span class="localvar">purchase</span>.getMember().alwaysPresent(<span class="localvar">member</span> -&gt; {
            <span class="localvar">bean</span>.<span class="attribute">memberName</span> = <span class="localvar">member</span>.getMemberName();
        });
        <span class="localvar">purchase</span>.getProduct().alwaysPresent(<span class="localvar">product</span> -&gt; {
            <span class="localvar">bean</span>.<span class="attribute">productName</span> = <span class="localvar">product</span>.getProductName();
            <span class="localvar">bean</span>.<span class="attribute">productHandleCode</span> = <span class="localvar">product</span>.getProductHandleCode();
        });
        <span class="localvar">bean</span>.purchaseDate = toStringDate(<span class="localvar">purchase</span>.getPurchaseDatetime()).get();
        <span class="localvar">bean</span>.purchasePrice = <span class="localvar">purchase</span>.getPurchasePrice();
        <span class="keyword">return</span> <span class="localvar">bean</span>;
    });
    <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>); 
}
</code></pre>
	<p>
		ちなみに、リフレクションで詰め替えるとかは強烈に非推奨です。
	</p>
	<div class="relatedpage"><a href="../../../tutorial/architect.html#entityset">EntityとDTOとの詰め替えは地道に</a></div>
	<h3 id="dispdata">表示データをResponseに設定</h3>
	<p>
		asHtml()を使っている場合、HTMLテンプレートに表示データを渡します。
	</p>
	<p>
		asHtml()に続いて、renderWith()メソッドを呼び、Lambda引数の data の register()
		を使って、HTMLテンプレート上で参照する名前をキーに、表示データを登録します。
	</p>
<pre><span class="codetitle">e.g. renderWith() in Action class @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    validate(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {}, () -&gt; {
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
    });
    ListResultBean&lt;Purchase&gt; <span class="localvar">purchaseList</span> = <span class="abbreviation">...</span>
    List&lt;SeaLandRowBean&gt; <span class="localvar">beans</span> = <span class="abbreviation">...</span>
    <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>).<span class="point">renderWith</span>(<span class="localvar">data</span> -&gt; {
        <span class="localvar">data</span>.<span class="subpoint">register</span>(<span class="literal">"beans"</span>, <span class="localvar">beans</span>);
    });
}
</code></pre>

	<h2 id="roughfinished">ラフスケッチできた</h2>
	<p>
		さて、これでラフスケッチ実装は終了です。全体像が、見えてきたでしょうか？
	</p>
	<p>
		この時点では、このような感じで Action ができあがっているはずです。
	</p>
<pre><span class="codetitle">e.g. rough sketch finished @Java</span><code>
<span class="comment">/**
 * @author yourname
 */</span>
<span class="keyword">public class</span> SeaLandAction <span class="keyword">extends</span> HarborBaseAction {

    @Execute
    <span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
        validate(<span class="localvar">form</span>, <span class="localvar">messages</span> -&gt; {}, () -&gt; {
            <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>);
        });
        ListResultBean&lt;Purchase&gt; <span class="localvar">purchaseList</span> = <span class="attribute">purchaseBhv</span>.selectList(<span class="localvar">cb</span> -&gt; {
            <span class="localvar">cb</span>.setupSelect_Member();
            <span class="localvar">cb</span>.setupSelect_Product();
            <span class="localvar">cb</span>.query().setProductId_Equal(<span class="localvar">productId</span>);
            <span class="localvar">cb</span>.orScopeQuery(<span class="localvar">orCB</span> -> {
                <span class="localvar">orCB</span>.query().setMemberId_Equal(<span class="localvar">userId</span>);
                <span class="localvar">orCB</span>.query().queryMember().existsMemberFollowingByYourMemberId(<span class="localvar">followingCB</span> -> {
                    <span class="localvar">followingCB</span>.query().setMyMemberId_Equal(<span class="localvar">userId</span>);
                });
            });
            <span class="localvar">cb</span>.query().existsPurchasePayment(<span class="localvar">paymentCB</span> -&gt; {
                <span class="localvar">paymentCB</span>.query().setPaymentMethodCode_Equal_AsPaymentMethod(form.<span class="attribute">pay</span>);
            });
            <span class="localvar">cb</span>.query().addOrderBy_PurchaseDatetime_Desc();
        });
        List&lt;SeaLandRowBean&gt; <span class="localvar">beans</span> = <span class="localvar">purchaseList</span>.mappingList(<span class="localvar">purchase</span> -&gt; {
            SeaLandRowBean <span class="localvar">bean</span> = <span class="keyword">new</span> SeaLandRowBean();
            <span class="localvar">bean</span>.<span class="attribute">purchaseId</span> = <span class="localvar">purchase</span>.getPurchaseId();
            <span class="localvar">purchase</span>.getMember().alwaysPresent(<span class="localvar">member</span> -&gt; {
                <span class="localvar">bean</span>.<span class="attribute">memberName</span> = <span class="localvar">member</span>.getMemberName();
            });
            <span class="localvar">purchase</span>.getProduct().alwaysPresent(<span class="localvar">product</span> -&gt; {
                <span class="localvar">bean</span>.<span class="attribute">productName</span> = <span class="localvar">product</span>.getProductName();
                <span class="localvar">bean</span>.<span class="attribute">productHandleCode</span> = <span class="localvar">product</span>.getProductHandleCode();
            });
            <span class="localvar">bean</span>.purchaseDate = toStringDate(<span class="localvar">purchase</span>.getPurchaseDatetime()).get();
            <span class="localvar">bean</span>.purchasePrice = <span class="localvar">purchase</span>.getPurchasePrice();
            <span class="keyword">return</span> <span class="localvar">bean</span>;
        });
        <span class="keyword">return</span> asHtml(<span class="attribute">path_Sea_SeaLandJsp</span>).renderWith(<span class="localvar">data</span> -&gt; {
            <span class="localvar">data</span>.<span class="subpoint">register</span>(<span class="literal">"beans"</span>, <span class="localvar">beans</span>);
        });
    }
}
</code></pre>
	<h3 id="firstboot">Bootしてアクセスしてみましょう</h3>
	<p>
		Bootクラスを起動して、実際にそのURLでアクセスしてみましょう。
		恐らく非常にそっけない画面しか表示されないと思いますが、ログをみてちゃんと動いていればこの先に進めます。
	</p>
	<p>
		ここでは、<em class="mark">HarborBoot</em> クラスの main() を実行しましょう。
	</p>
<pre><span class="codetitle">e.g. HarborBoot @Java</span><code>
/**
 * @author jflute
 */
<span class="keyword">public class</span> HarborBoot { <span class="comment">// #change_it_first</span>

    <span class="keyword">public static void</span> main(String[] args) { <span class="comment">// e.g. java -Dlasta.env=production -jar harbor.war</span>
        <span class="keyword">new</span> JettyBoot(<span class="literal">8090</span>, <span class="literal">"/harbor"</span>).useTldDetect().asDevelopment(isNoneEnv()).bootAwait();
    }

    <span class="keyword">private static boolean</span> isNoneEnv() {
        return System.getProperty(<span class="literal">"lasta.env"</span>) == null;
    }
}
</code></pre>
<pre><span class="codetitle">e.g. boot log @Console</span><code>
INFO  (...@showBoot():105) - _/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/_/
INFO  (...@showBoot():106) -  the system has been initialized:
INFO  (...@showBoot():107) - 
INFO  (...@showBoot():108) -   -> Harbor (Local Development)
INFO  (...@showBoot():109) - _/_/_/_/_/_/_/_/_/_/
Boot successful as development: url -> <span class="literal">http://localhost:8090/harbor</span>
</code></pre>
	<p>
		ここでは、<a href="http://localhost:8090/harbor/sea/land/3?pay=HAN"><em class="mark">http://localhost:8090/harbor/sea/land/3?pay=HAN</em></a> にアクセスしてみましょう。
		<span class="frm">(いちど、ログイン画面に飛ばされますので、'Pixy', 'sea' と入力してログイン)</span>
	</p>
	<h3 id="tomethod">ちょいっとリファクタリング</h3>
	<p>
		ちょっとメソッド長いですね。実際に業務だと、もっと大きくなる可能性があります。
	</p>
	<p>
		TODO jflute リファクタリングする
	</p>

	<h2 id="adjustment">いろいろ調整しながら実装</h2>
	<p>
		TODO jflute ポイントポイントの説明を書く
	</p>

	<h2 id="littletips">ちょこっとTips</h2>
	<h3 id="supermethod">スーパークラスのメソッド、何が使える？</h3>
	<p>
		Actionクラスの中で、this.docu...() と document
		メソッドを補完して、JavaDocを表示してみてください。すると...
	</p>
<pre><span class="codetitle">e.g. document methods @Java</span><code>
@Execute
<span class="keyword">public</span> HtmlResponse index(<span class="keyword">int</span> <span class="localvar">productId</span>, SeaLandForm <span class="localvar">form</span>) {
    <span class="abbreviation">...</span>
    <span class="point">this.docu</span> <span class="comment">// 補完して、IDE上でJavaDoc表示</span>
    <span class="abbreviation">...</span>
}
</code></pre>
	<p>
		実装しながら、ふとActionの規約を忘れちゃったときとか、ブラウザで検索してドキュメントを探す...ではなく、
		ササッと this.docu... ってやってみるといいかもですね。
	</p>

	<h2 id="office">事務連絡</h2>
	<p>
		harbor で、実際に SeaLandAction
		を作っていくと、HarborHtmlPath など幾つかのリソースに修正マークが付いてしまいます。
		<span class="frm">(Actionとかは、gitignoreしてますが、どうしても無視設定できない修正が...)</span>
	</p>

</div>
</div>

<div id="sidebar">
	<div class="logo"><a href="../../../../"><img src="../../../../image/parts/logo.png" alt="dbflute-logo" width="240" height="110" /></a></div>
<ul>
		<li><a href="../../../../ja/lastaflute/index.html">LastaFluteトップページ</a>
			<ul>
				<li><a href="../../../../ja/lastaflute/index.html#about">LastaFluteとは？</a></li>
				<li><a href="../../../../ja/lastaflute/index.html#lacode">LastaFluteのコード</a></li>
				<li class="upper-space"><a href="../../../../ja/lastaflute/index.html#quicktrial">動かしてみよう</a></li>
				<li><a href="../../../../ja/lastaflute/index.html#newproject">新プロジェクト</a></li>
				<li><a href="https://github.com/lastaflute/lastaflute">LastaFlute | Github</a></li>
			</ul>
		</li>
		<li><a href="../../../../ja/lastaflute/tutorial/laimpl.html">LastaFlute実装チュートリアル</a>
			<ul>
				<li><a href="../../../../ja/lastaflute/tutorial/laimpl.html#style">実装スタイル</a></li>
				<li><a href="../../../../ja/lastaflute/tutorial/laimpl.html#prepare">まず準備</a></li>
				<li class="upper-space"><a href="../../../../ja/lastaflute/tutorial/laimpl.html#acquaintanceship">ディベロッパーの心得</a></li>
				<li><a href="../../../../ja/lastaflute/tutorial/laimpl.html#tenclause">ディベロッパーの十か条</a></li>
				<li><a href="../../../../ja/lastaflute/tutorial/faqimpl.html">LastaFluteの実装FAQ</a></li>
			</ul>
		</li>
		<li><a href="../../../../ja/lastaflute/howto/action/makeashtml.html">Actionの作り方 (HTML)</a>
			<ul>
				<li><a href="../../../../ja/lastaflute/howto/action/makeashtml.html#makeaction">Actionクラスを作る</a></li>
				<li><a href="../../../../ja/lastaflute/howto/action/makeashtml.html#implexecute">Executeメソッドを実装</a></li>
			</ul>
		</li>
		<li><a href="../../../../ja/lastaflute/lastadi/index.html">Lasta Diトップページ</a>
			<ul>
				<li><a href="../../../../ja/lastaflute/lastadi/index.html#twocomp">Two Components</a></li>
				<li><a href="../../../../ja/lastaflute/lastadi/dixmlexp.html">Di xml の表現</a></li>
				<li><a href="https://github.com/lastaflute/lasta-di">Lasta Di | Github</a></li>
			</ul>
		</li>
		<li><a href="../../../../ja/tutorial/onjava8.html">DBFlute on Java8</a>
			<ul>
				<li><a href="../../../../ja/tutorial/onjava8.html#select">とにかく検索は？</a></li>
				<li><a href="../../../../ja/tutorial/onjava8.html#completion">さあ、補完してみよう！</a></li>
			</ul>
		</li>
	</ul>

</div>

<div id="footer">
	<div><a href="../../../../ja/sitemap.html">SiteMap</a> <a href="http://d.hatena.ne.jp/jflute">Author's Blog</a><a href="https://www.seasar.org/issues/browse/DBFLUTE">BTS</a></div>
	<ul class="footer-navi">
		<li class="hd-introduction"><a href="../../../../ja/introduction/index.html">Introduction</a></li>
		<li class="hd-tutorial"><a href="../../../../ja/tutorial/index.html">Tutorial</a>
			<ul>
				<li class="hd-architect"><a href="../../../../ja/tutorial/architect.html">for Architect</a></li>
				<li class="hd-developer"><a href="../../../../ja/tutorial/developer.html">for Developer</a></li>
			</ul>
		</li>
		<li class="hd-environment"><a href="../../../../ja/environment/index.html">Environment</a>
			<ul>
				<li class="hd-install"><a href="../../../../ja/environment/setup/index.html">Setup</a></li>
				<li class="hd-upgrade"><a href="../../../../ja/environment/upgrade/index.html">Upgrade</a></li>
			</ul>
		</li>
		<li class="hd-manual"><a href="../../../../ja/manual/index.html">Manual</a></li>
	</ul>

</div>

</div>
</body>
</html>
