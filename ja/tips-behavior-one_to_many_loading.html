<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- don't edit start -->
<head>
<title>Seasar - DI Container with AOP - </title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta http-equiv="Content-Style-Type" content="text/css" />
<link href="seasar_b.css" type="text/css" rel="stylesheet" media="screen" />
<link href="seasar_p.css" type="text/css" rel="stylesheet" media="print" />
<script src="seasar_b.js" type="text/JavaScript" language="JavaScript"></script>
</head>
<body onload="preload('ja')">
<table width="100%" border="0" cellspacing="0" cellpadding="0" align="left"><tr>
<td align="left" valign="top" width="780"><table width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr><td colspan="7"><img height="5" width="780" src="images/top01_b.gif" alt=""></td></tr>
<tr><td><img height="117" width="235" src="images/top02_b.gif" alt="Seasar"></td>
<td colspan="3"><img height="117" width="289" src="images/top03.gif" alt="DI Container with AOP"></td>
<td colspan="3"><img height="117" width="256" src="images/spacer.gif" alt=""></td>
</tr><tr><td rowspan="2"><img src="images/top04.gif" alt="" height="49" width="235"></td>
<td><a href="http://www.seasar.org/index.html"><img src="images/menu01_b_ja.gif" height="30" width="78" border="0" alt="" id="menu01" onmouseover="swap(1)" onmouseout="restore(1)"></a></td>
<td><a href="http://www.seasar.org/projects.html"><img src="images/menu02_b_ja.gif" height="30" width="101" border="0" alt="" id="menu02" onmouseover="swap(2)" onmouseout="restore(2)"></a></td>
<td><a href="http://www.seasar.org/products.html"><img src="images/menu03_b_ja.gif" height="30" width="110" border="0" alt="" id="menu03" onmouseover="swap(3)" onmouseout="restore(3)"></a></td>
<td><a href="http://www.seasar.org/resources.html"><img src="images/menu04_b_ja.gif" height="30" width="113" border="0" alt="" id="menu04" onmouseover="swap(4)" onmouseout="restore(4)"></a></td>
<td><img src="images/menu05_b_ja.gif" height="30" width="109" border="0" alt="" id="menu05" onmouseover="swap(5)" onmouseout="restore(5)"></td>
<td><img height="30" width="34" src="images/menu06.gif" alt=""></td></tr><tr>
<td colspan="6"><img height="19" width="545" src="images/spacer.gif" alt=""></td></tr></table>
<table  width="780" border="0" cellspacing="0" cellpadding="0" class="white">
<tr align="left" valign="top"><td width="14"><img height="14" width="14" src="images/spacer.gif" alt=""></td><td width="740" class="main">
<!-- don't edit end -->
<!-- document start -->
<p>
<a href="index.html">to Top</a>
<p><b>
Behaviorの{one-to-many loading}機能について記述します。
<p></b>
<pre>


// ======================================================================================================
//                                                                         Behavior - one-to-many loading
//                                                                         ==============================


S2Daoでは{1:n}検索をサポートしていません(S2Dao-1.0.XXにおいて)。

    ex) BOOK(本)の一覧に紐付くCOLLECTION(蔵書)の情報を付加して検索
        (COLLECTIONが一つも存在しないBOOKも対象)
    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    select book.*, collection.*
      from BOOK book
        left outer join Collection collection on book.BOOK_ID = collection.BOOK_ID
     where ...
    - - - - - - - - /

このようなSQLの結果を、S2Daoでは Book-Entity(親) と Collection-Entity(子) のObject-Graphで取得することができません。

ひらべったく情報を取得するのは：
  “外だしSQL”をガッツリ書いて、子供のColumnの値の受け口を以下の方法で作る。
  「Book-Entityに導出列Propertyを定義する or Sql2Entityを使ってSelect句と同構成のEntityを自動生成する」

これで欲しい情報は取得できますが、Object-Graphを取得することはできません。
呼び出したLogicが自分でコントロールブレイク処理を行って展開しなければなりません。


DBFluteでは、これに対し以下のようなApproachで対応します。

    ********************************************************************************************
    1. 取得したいBOOKの一覧を検索する。(この時点でCOLLECTIONは検索しない)

    2. BOOKのPrimaryKey(or UniqueKey)のListを作成し、それをInScopeの条件としてCOLLECTIONを検索。
         →OrderByは、{COLLECTION.BOOK_ID asc, [指定されたOrderBy]}

    3. 取得したCOLLECTIONの一覧からBOOK_IDをKeyにして該当のBOOKにCOLLECTIONを追加する。
    ********************************************************************************************

一発のSQLではありませんが、「BOOKの検索・COLLECTIONの検索」の二発のSQLで実現します。

    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    これはLazyLoadではありません。
    BOOKが1件でも50件でもそれ(それら)の子供のCOLLECTIONを全て一発で取得します。
    - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

これらの処理がBehaviorと呼ばれるObjectのMethodにて実装されています。

    ex) BOOK(本)の一覧に紐付くCOLLECTION(蔵書)の情報を付加して検索
        - COLLECTIONが一つも存在しないBOOKも対象とする。
        - AUTHOR / PUBLISHERを結合する。
        - 本の名前が'S2Dao'で始まるものを対象とする。
        - 本の名前の昇順で取得する。
        - 本に紐付くCOLLECTIONの一覧は、COLLECTION_ID(PK)の昇順とする。
    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    final LdBookCB cb = new LdBookCB();
    cb.setupSelect_Author();
    cb.setupSelect_Publisher();
    cb.query().setBookName_Prefix("S2Dao");
    cb.query().addOrderBy_BookName_Asc();

    final LdBookDao dao = ... // Dao-Componentを取得
    final LdBookBhv bhv = ... // Behavior-Componentを取得

    // BOOKの検索
    final java.util.List&lt;LdBook&gt; ls = dao.selectList(cb);

    // BOOKに紐付くCOLLECTIONの検索・関連付け
    bhv.loadCollectionList(ls); // DefaultのOrderByはPKの昇順

    for (LdBook entity : ls) {
        final java.util.List reffererList = entity.getCollectionList();
        assertNotNull(reffererList);
    }
    - - - - - - - - /

また、第2引数にてReffererのOrderBy条件や絞り込み条件などを指定することが可能です。

    ex) 上記の例の条件に加え、
         - COLLECTIONのSTATUSが'WAT'(入荷待ち)でないもので絞り込む。
         - COLLECTIONをARRIVAL_DATE(到着日)の降順で並べる。
    / - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
    final LdBookCB cb = new LdBookCB();
    cb.setupSelect_Author();
    cb.setupSelect_Publisher();
    cb.query().setBookName_Prefix("S2Dao");
    cb.query().addOrderBy_BookName_Asc();

    final LdBookDao dao = ... // Dao-Componentを取得
    final LdBookBhv bhv = ... // Behavior-Componentを取得

    // BOOKの検索
    final java.util.List&lt;LdBook&gt; ls = dao.selectList(cb);

    // BOOKに紐付くCOLLECTIONの検索・関連付け
    // COLLECTIONの条件に、「STATUSが'WAT'(入荷待ち)でないもの」と「ARRIVAL_DATE(到着日)の降順」を追加
    final LdCollectionBhv.CBSetupper cbSetupper = new LdCollectionBhv.CBSetupper() {
        public void setup(LdCollectionCB cb) {
            cb.query().queryCollectionStatus().setCollectionStatusCode_NotEqual('WAT');
            cb.query().addOrderBy_ArribalDate_Desc();
        }
    };
    bhv.loadCollectionList(ls, cbSetupper);

    for (LdBook entity : bhv) {
        final java.util.List reffererList = entity.getCollectionList();
        assertNotNull(reffererList);
    }
    - - - - - - - - /


このやり方が理想なのかと問われると「NO!」ではありますが、
業務で許容される範囲での利用であればとても有効に使える機能だと作者は考えています。

</pre>
</p>

<!-- document end -->
</html>
