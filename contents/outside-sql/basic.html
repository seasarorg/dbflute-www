<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<!--  todo keywordsなど -->
	<style type="text/css" title="currentStyle">
		@import "../../css/main.css";
	</style>
	<title>DBFlute : Outside SQL</title>
</head>
<body>

<div id="header">
	<h1><a href="../index.html">DBFlute</a></h1>
	<div>
		<ul>
			<li><a href="../../ja/index.html">home</a></li>
			<li><a href="../../ja/index.html#download">download</a></li>
			<li><a href="../../ja/index.html#document" class="active">document</a></li>
			<li><a href="../../ja/index.html#tracking">bts</a></li>
		</ul>
	</div>
</div>
<div id="content"><!-- __content-start__ -->
	<h2>外だしSQLの基本</h2>
	<p>外だしSQLを実装する場合も、ConditionBeanと同じくBehaviorを使います。</p>
	
	<h3>前提</h3>
	<p>
		以前は、S2Daoをそのまま利用する「Daoを利用した外だしSQL」のやり方を利用していましたが、
Behaviorのみで全てのDBアクセスを可能にするため、Behaviorで外だしSQLを実行することが可能になりました。<br />
(外だしSQLのみDaoを意識しなければならず、S2Daoを知らない初心者には敷居が高いという意見がありました)
	</p>
	<p>
		その際、ジェネリックの利用、SQLファイルの自由度アップ、外だしSQLのページング検索の向上など、
様々な改善が施されています。
	</p>
	<h3>利用可能バージョン</h3>
	<p>
		[Java-1.4]の場合<br />
		未実装です。<br />
		Genericを前提とした処理のため、今後も実装予定はありません。<br />
		「Daoを利用した伝統的な外だしSQL」をご利用下さい。
	</p>
	<p>
		[Java-5.0 or Java6.0]の場合<br />
		DBFlute-0.5.8より利用可能です。
	</p>
	<p>
		[C#-2.0 or C-#3.0]<br />
		DBFlute-0.5.8より利用可能です。
	</p>
	<h3>説明の前に</h3>
	<p>
		外だしSQLは基本として利用頻度の一番高い「リスト検索(一覧検索)」を取り上げます。<br />
		「１件検索」や「ページング検索」に関してはこのページの最後にリンクがあります。<br />
		<br />
		また、例題は“理解し易さ”を考慮して簡単なSQLとなっております。<br />
		(実際にはConditionBeanで実現できるレベルのSQLとなっています)
	</p>
	<h3>実装手順</h3>
	<p>
		[概要]
	</p>
	<ol>
		<li>任意のパッケージにxxx.sqlファイルを作成する。</li>
		<li>xxx.sqlファイルにSQLを2Way-SQLで実装する。</li>
		<li>Sql2Entityを実行する。</li>
		<li>BehaviorのoutsideSql()メソッドを利用して作成したSQLを呼び出すプログラムを実装する。</li>
	</ol>
	<p>
		[詳細]
	</p>
	<ol>
		<li>
			<h4>任意のパッケージにxxx.sqlファイルを作成する。</h4>
			<p>ex) SQLファイルの配置</p>
			<code>
				sql/member/selectSimpleMember.sql
			</code>
			<p>
				SQLファイルは、以下のディレクトリ配下に配置して下さい。<br />
				<ul>
					<li>Java版 ： 「../src/main/resources」</li>
					<li>C#版 ： 「../source」</li>
					<p>※「../」はDBFluteクライアントディレクトリからの相対パスを示します。</p>
				</ul>
				もし、「torque.java.dir」にて独自の自動生成クラス出力先を設定している場合は、
				その指定したディレクトリ配下に配置するようにして下さい。<br />
				「torque.java.dir」に関して詳しくはこちら(★工事中)<br />
			</p>
			<p>
				SQLファイルのキャラセットはデフォルト「UTF-8」です。<br />
				もし、その他のキャラセットを利用する場合は「torque.daoSqlFileEncoding」にて指定します。<br />
				「torque.daoSqlFileEncoding」に関して詳しくはこちら(★工事中)
			</p>
			<p>
				C#版では、作成したSQLファイルのビルドアクションを「埋め込まれたリソース」にして下さい。<br />
				これを設定しないと、DLL内にSQLファイルが含まれず、SQLを読み込むことができないためです。
			</p>
		</li>
		<li>
			<h4>xxx.sqlファイルにSQLを2Way-SQLで実装する。</h4>
			<p>
			ポイントは以下の通りです：
				<ul>
					<li>Sql2Entityの宣言を行う。</li>
					<p>
						基本的に「戻り値EntityとしてCustomizeEntity」・「引数BeanとしてParameterBean」を利用する。<br />
						戻り値EntityにDomainEntityを利用することも可能なので、その場合はCustomizeEntityは不要となる。<br />
						また、引数が１つもないSQLやMapParameterBeanを利用する場合はParameterBeanも不要となる。<br />
						(但し、実際の開発において、CustomizeEntityとParameterBeanの利用が必要なSQLが多い)
					</p>
					<li>引数のParameterBeanへの参照は、「pmb」という変数名を利用することを習慣とする。</li>
					<li>SQLコメントの文法はS2Daoとほぼ同じである。(一部拡張あり)</li>
					<p>
						→ SQLコメントの文法に関して詳しくはこちら(★工事中)<br />
						→ C#版だとコメント内で利用するプロパティ名の先頭が大文字であることに注意。
					</p>
				</ul>
			</p>
			<pre>ex) 2Way-SQLでの実装（戻り値にCustomizeEntity・引数にParameterBeanを利用）
			<code>
-- #SimpleMember#

-- !SimpleMemberPmb!
-- !!Integer memberId!!
-- !!String memberName!!

select member.MEMBER_ID
     , member.MEMBER_NAME
     , memberStatus.MEMBER_STATUS_NAME
/*END*/
  from MEMBER member
    left outer join MEMBER_STATUS memberStatus
      on member.MEMBER_STATUS_CODE = memberStatus.MEMBER_STATUS_CODE
 /*BEGIN*/where
   /*IF pmb.memberId != null*/member.MEMBER_ID = /*pmb.memberId*/3/*END*/
   /*IF pmb.memberName != null*/and member.MEMBER_NAME like /*pmb.memberName*/'ス' || '%'/*END*/
   /*END*/
 /*END*/
 order by member.MEMBER_ID asc
			</code>
			</pre>
		</li>
		<li>
			<h4>Sql2Entityを実行する。</h4>
			<p>
				Sql2Entity実行後は、IDE上で「プロジェクトの更新」をして下さい。自動生成されたクラスがIDEに認識されます。
			</p>
			<p>
				Sql2Entityに関しては<a href="../../ja/tips-sql2entity.html">こちら</a>
			</p>
		</li>
		<li>
			<h4>BehaviorのoutsideSql()メソッドを利用して作成したSQLを呼び出すプログラムを実装する。</h4>
			<p>
			ポイントは以下の通りです：
				<ul>
					<li>BehaviorのoutsideSql()メソッドの後、「selectList()」メソッドを呼び出す。</li>
					<p>
						→ 該当の外だしSQLにおいて一番基点となるテーブルのBehaviorを利用するのを習慣とする。<br />
					</p>
					<li>引数として「SQLのパス」・「ParameterBean」・「戻り値Entityの型」を指定する。</li>
					<p>
						→ 「SQLのパス(path)」は必須。<br />
						→ 「ParameterBean(pmb)」はSQLに渡す引数が無い場合は不要。<br />
						→ 「戻り値Entityの型(entityType)」は必須。<br />
					</p>
				</ul>
			</p>
			<p>ex) リスト検索のテスト実装｛条件：名前が'ス'で始まる会員であること｝</p>
			<pre>
			<code>
public void test_outsideSql_selectSimpleMember_Tx() throws Exception {
    // ## Arrange ##
    // SQLのパス
    final String path = "sql/member/selectSimpleMember.sql";

    // 検索条件
    final SimpleMemberPmb pmb = new SimpleMemberPmb();
    pmb.setMemberName("ス");

    // 戻り値Entityの型
    final Class&lt;SimpleMember&gt; entityType = SimpleMember.class;

    // ## Act ##
    // SQL実行！
    final List&lt;SimpleMember&gt; resultList = memberBhv.outsideSql().selectList(path, pmb, entityType);

    // ## Assert ##
    assertNotSame("テストの成立のため１件以上は必ずあること: " + resultList.size(), 0, resultList.size());
    log("{SimpleMember}");
    for (SimpleMember entity : resultList) {
        final Integer memberId = entity.getMemberId();
        final String memberName = entity.getMemberName();
        final String memberStatusName = entity.getMemberStatusName();
        log("    " + memberId + " - " + memberName + " - " + memberStatusName);
        assertNotNull(memberId);
        assertNotNull(memberName);
        assertNotNull(memberStatusName);
        assertTrue("The memberName should start with 'ス': " + memberName, memberName.startsWith("ス"));
    }
}
			</code>
			</pre>
			<p>ex) 実行ログ｛条件：名前が'ス'で始まる会員であること｝</p>
			<pre>
			<code>
(S2DaoInterceptor#traceMethod():201) - /===============================================================================
(S2DaoInterceptor#traceMethod():202) -                                                       OutsideSqlDao.selectList()
(S2DaoInterceptor#traceMethod():203) -                                                       =========================/
(S2DaoInterceptor#traceMethod():211) - OutsideSql: sql/member/selectSimpleMember.sql
(S2DaoInterceptor#traceSqlCommand():444) - SqlCommand Initialization Cost: [00m02s156ms]
(Logger#debug():105) - -- #SimpleMember#

-- !SimpleMemberPmb!
-- !!Integer memberId!!
-- !!String memberName!!

select member.MEMBER_ID
     , member.MEMBER_NAME
     , memberStatus.MEMBER_STATUS_NAME

  from MEMBER member
    left outer join MEMBER_STATUS memberStatus
      on member.MEMBER_STATUS_CODE = memberStatus.MEMBER_STATUS_CODE
 where
   
   member.MEMBER_NAME like 'ス' || '%'
   
 
 order by member.MEMBER_ID asc
(S2DaoInterceptor#traceReturn():479) - ===========/ [00m02s484ms - Selected list: 2 first={1,ストイコビッチ,正式会員}]
(S2DaoInterceptor#traceReturn():496) -  
(AppTestBase#log():69) - {SimpleMember}
(AppTestBase#log():69) -     1 - ストイコビッチ - 正式会員
(AppTestBase#log():69) -     4 - スタンコビッチ - 正式会員
			</code>
			</pre>
			<p>
				SQL上のSelect句の指定カラムを１つにして、戻り値Entityの型としてStringやIntegerを指定することも可能です。
			</p>
			<pre><code>
final List&lt;String&gt; valueList = memberBhv.outsideSql().selectList(path, pmb, String.class);
			</code></pre>
		</li>
	</ol>
	<h3>様々な外だしSQL</h3>
	<p>
		<ul>
			<li>外だしSQLの一件検索は<a href="./entity.html">こちら</a></li>
			<li>外だしSQLのページング検索は<a href="./paging.html">こちら</a></li>
			<li>外だしSQLのカーソル検索は<a href="./cursor.html">こちら</a></li>
			<li>外だしSQLの動的バインド変数検索は<a href="./dynamic.html">こちら(★工事中)</a></li>
		</ul>	
	</p>
	
<!-- __content-end__ --></div>

<div id="sideBar">
	<h3>menu</h3>
	<ul>
		<li>工事中</li>
	</ul>
	<!-- 
	<h3>自動生成をする</h3>
	<ul>
		<li><a href="./sample.html">タスク一覧</a></li>
		<li><a href="./sample.html">HowToSetUp</a></li>
		<li><a href="./sample.html">プロパティ解説</a></li>
	</ul>
	<h3>自動生成されたソースを使用する</h3>
	<ul>
		<li><a href="./sample.html">生成されるソースのクラス図</a></li>
		<li><a href="./sample.html">ConditionBean</a>
			<ul>
				<li><a href="./sample.html">ConditionBeanとは</a></li>
				<li><a href="./sample.html">使い方</a></li>
			</ul>
		</li>
		<li><a href="./sample.html">Behavior</a></li>
		<li><a href="./sample.html">Paging</a>
			<ul>
				<li><a href="./sample.html">ConditionBeanによるPaging</a></li>
				<li><a href="./sample.html">外だしSQLによるPaging</a></li>
			</ul>
		</li>
	</ul>
	<h3>その他</h3>
	<ul>
		<li><a href="./sample.html">SchemaHTML</a></li>
		<li><a href="./sample.html">Sql2Entity</a></li>
		<li><a href="./sample.html">用語集</a></li>
		<li><a href="./sample.html">サンプル解説</a></li>
	</ul>
	-->
</div>

<div id="footer">
<!-- 
	<ul>
		<li><a href="./sample.html">seasar</a></li>
		<li><a href="./sample.html">s2dao</a></li>
		<li><a href="./sample.html">teeda</a></li>
	</ul>
	 -->
</div>

</body>
</html>