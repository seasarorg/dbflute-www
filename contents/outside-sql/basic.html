<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<!--  todo keywordsなど -->
	<style type="text/css" title="currentStyle">
		@import "../../css/main.css";
	</style>
	<title>DBFlute</title>
</head>
<body>

<div id="header">
	<h1><a href="../index.html">DBFlute</a></h1>
	<div>
		<ul>
			<li><a href="../../ja/index.html">home</a></li>
			<li><a href="../../ja/index.html#download">download</a></li>
			<li><a href="../../ja/index.html#document" class="active">document</a></li>
			<li><a href="../../ja/index.html#tracking">bts</a></li>
		</ul>
	</div>
</div>
<div id="content"><!-- __content-start__ -->
	<h2>外だしSQLの基本</h2>
	<p>
		そもそも外だしSQLとは？については<a href="./about.html">こちら</a>
	</p>
	<h3>前提</h3>
	<h4>利用可能バージョン</h4>
	<p>
		<ul>
			<li>
				[Java-1.4]の場合 → 未実装です。Genericを前提とした処理のため、今後も実装予定はありません。
			</li>
			<li>
				[Java-5.0 or Java6.0 or C#-2.0 or C-#3.0]の場合 → DBFlute-0.5.8より利用可能です。
			</li>
		</ul>
	</p>
	<h4>新方式の経緯</h4>
	<p>
		以前は、S2Daoをそのまま利用する「Daoを利用した外だしSQL」のやり方を利用していましたが、<br />
		Behaviorのみで全てのDBアクセスを可能にするため、Behaviorで外だしSQLを実行することが可能になりました。<br />
		(外だしSQLのときだけDaoを意識しなければならず、S2Daoを知らない初心者には敷居が高いという意見がありました)
	</p>
	<p>
		その際、ジェネリックの利用、SQLファイルの自由度アップ、外だしSQLのページング検索の向上など、
様々な改善が施されています。<br />
		もちろん今までの「Daoを利用した外だしSQL」は、今後も利用可能です。
	</p>
	<h4>説明の前に</h4>
	<p>
		外だしSQLの基本では、利用頻度の一番高い「リスト検索(一覧検索)」を取り上げています。<br />
		その他検索(１件検索やページング検索)については、このページの最後にリンクがありますのでそちらご覧下さい。<br />
		また、例題は“理解し易さ”を考慮して簡単なSQL(ConditionBeanで実現できるレベル)となっております。<br />
	</p>
	<h3>実装概要</h3>
	<p>
		外だしSQLを実装する場合も、ConditionBeanと同じくBehaviorを使います。
		<pre>ex) 会員名称に'ス'を指定して外だしSQLを実行<code>
final SimpleMemberPmb pmb = new SimpleMemberPmb();
pmb.setMemberName("ス");
final List&lt;SimpleMember&gt; resultList = memberBhv.outsideSql().selectList("sql/member/xxx.sql", pmb, SimpleMember.class);
		</code></pre>
	</p>
	<p>
		実装の流れは以下のようになります：
	</p>
	<ol>
		<li>任意のパッケージにxxx.sqlファイルを作成する。</li>
		<li>xxx.sqlファイルにSQLを2Way-SQLで実装する。</li>
		<li>Sql2Entityを実行する。</li>
		<li>BehaviorのoutsideSql()メソッドを利用して作成したSQLを呼び出すプログラムを実装する。</li>
	</ol>
	<h3>実装手順</h3>
	<ol>
		<li>
			<h4>任意のパッケージにxxx.sqlファイルを作成する。</h4>
			<p>ex) SQLファイルの配置</p>
			<code>
				sql/member/selectSimpleMember.sql
			</code>
			<p>
				SQLファイルは、以下のディレクトリ配下に配置して下さい。<br />
				<ul>
					<li>Java版 ： 「../src/main/resources」</li>
					<li>C#版 ： 「../source」</li>
					<p>※「../」はDBFluteクライアントディレクトリからの相対パスを示します。</p>
				</ul>
				もし、「torque.java.dir(についてはこちら(★工事中))」にて独自の自動生成クラス出力先を設定している場合は、<br />
				その指定したディレクトリ配下に配置するようにして下さい。<br />
			</p>
			<p>
				SQLファイルのキャラセットはデフォルト「UTF-8」です。<br />
				その他のキャラセットを利用する場合は「torque.daoSqlFileEncoding(についてはこちら(★工事中))」にて指定します。<br />
			</p>
			<p>
				C#版では、作成したSQLファイルのビルドアクションを「埋め込まれたリソース」にして下さい。<br />
				これを設定しないと、DLL内にSQLファイルが含まれず、SQLを読み込むことができないためです。
			</p>
		</li>
		<li>
			<h4>xxx.sqlファイルにSQLを2Way-SQLで実装する。</h4>
			<p>
			ポイントは以下の通りです：
				<ul>
					<li>Sql2Entityの宣言を行う。</li>
					<li>引数のParameterBeanへの参照は、「pmb」という変数名を利用することを習慣とする。</li>
					<li>パラメータコメントを利用する。パラメータコメントについては<a href="./pmcomment.html">こちら</a></li>
				</ul>
			</p>
			<pre>ex) 2Way-SQLでの実装（戻り値にCustomizeEntity・引数にParameterBeanを利用）
			<code>
-- #SimpleMember#

-- !SimpleMemberPmb!
-- !!Integer memberId!!
-- !!String memberName!!

select member.MEMBER_ID
     , member.MEMBER_NAME
     , memberStatus.MEMBER_STATUS_NAME
/*END*/
  from MEMBER member
    left outer join MEMBER_STATUS memberStatus
      on member.MEMBER_STATUS_CODE = memberStatus.MEMBER_STATUS_CODE
 /*BEGIN*/where
   /*IF pmb.memberId != null*/member.MEMBER_ID = /*pmb.memberId*/3/*END*/
   /*IF pmb.memberName != null*/and member.MEMBER_NAME like /*pmb.memberName*/'ス' || '%'/*END*/
   /*END*/
 /*END*/
 order by member.MEMBER_ID asc
			</code>
			</pre>
		</li>
		<li>
			<h4>Sql2Entityを実行する。</h4>
			<p>
				Sql2Entityについては<a href="./sql2entity.html">こちら</a><br />
			</p>
		</li>
		<li>
			<h4>BehaviorのoutsideSql()メソッドを利用して作成したSQLを呼び出すプログラムを実装する。</h4>
			<p>
			ポイントは以下の通りです：
				<ul>
					<li>BehaviorのoutsideSql()メソッドの後、「selectList()」メソッドを呼び出す。</li>
					<p>
						→ 該当の外だしSQLにおいて一番基点となるテーブルのBehaviorを利用するのを習慣とする。<br />
					</p>
					<li>引数として「SQLのパス」・「ParameterBean」・「戻り値Entityの型」を指定する。</li>
					<p>
						→ 「SQLのパス(path)」は必須。<br />
						→ 「ParameterBean(pmb)」はSQLに渡す引数が無い場合は不要。<br />
						→ 「戻り値Entityの型(entityType)」は必須。<br />
					</p>
				</ul>
			</p>
			<p>ex) リスト検索のテスト実装｛条件：名前が'ス'で始まる会員であること｝</p>
			<pre>
			<code>
public void test_outsideSql_selectSimpleMember_Tx() throws Exception {
    // ## Arrange ##
    // SQLのパス
    final String path = "sql/member/selectSimpleMember.sql";

    // 検索条件
    final SimpleMemberPmb pmb = new SimpleMemberPmb();
    pmb.setMemberName("ス");

    // 戻り値Entityの型
    final Class&lt;SimpleMember&gt; entityType = SimpleMember.class;

    // ## Act ##
    // SQL実行！
    final List&lt;SimpleMember&gt; resultList = memberBhv.outsideSql().selectList(path, pmb, entityType);

    // ## Assert ##
    assertNotSame("テストの成立のため１件以上は必ずあること: " + resultList.size(), 0, resultList.size());
    log("{SimpleMember}");
    for (SimpleMember entity : resultList) {
        final Integer memberId = entity.getMemberId();
        final String memberName = entity.getMemberName();
        final String memberStatusName = entity.getMemberStatusName();
        log("    " + memberId + " - " + memberName + " - " + memberStatusName);
        assertNotNull(memberId);
        assertNotNull(memberName);
        assertNotNull(memberStatusName);
        assertTrue("The memberName should start with 'ス': " + memberName, memberName.startsWith("ス"));
    }
}
			</code>
			</pre>
			<p>ex) 実行ログ｛条件：名前が'ス'で始まる会員であること｝</p>
			<pre>
			<code>
(S2DaoInterceptor#traceMethod():201) - /===============================================================================
(S2DaoInterceptor#traceMethod():202) -                                                       OutsideSqlDao.selectList()
(S2DaoInterceptor#traceMethod():203) -                                                       =========================/
(S2DaoInterceptor#traceMethod():211) - OutsideSql: sql/member/selectSimpleMember.sql
(S2DaoInterceptor#traceSqlCommand():444) - SqlCommand Initialization Cost: [00m02s156ms]
(Logger#debug():105) - -- #SimpleMember#

-- !SimpleMemberPmb!
-- !!Integer memberId!!
-- !!String memberName!!

select member.MEMBER_ID
     , member.MEMBER_NAME
     , memberStatus.MEMBER_STATUS_NAME

  from MEMBER member
    left outer join MEMBER_STATUS memberStatus
      on member.MEMBER_STATUS_CODE = memberStatus.MEMBER_STATUS_CODE
 where
   
   member.MEMBER_NAME like 'ス' || '%'
   
 
 order by member.MEMBER_ID asc
(S2DaoInterceptor#traceReturn():479) - ===========/ [00m02s484ms - Selected list: 2 first={1,ストイコビッチ,正式会員}]
(S2DaoInterceptor#traceReturn():496) -  
(AppTestBase#log():69) - {SimpleMember}
(AppTestBase#log():69) -     1 - ストイコビッチ - 正式会員
(AppTestBase#log():69) -     4 - スタンコビッチ - 正式会員
			</code>
			</pre>
			<p>
				SQL上のSelect句の指定カラムを１つにして、戻り値Entityの型としてStringやIntegerを指定することも可能です。
			</p>
			<pre><code>
final List&lt;String&gt; valueList = memberBhv.outsideSql().selectList(path, pmb, String.class);
			</code></pre>
		</li>
	</ol>
	<h3>様々な外だしSQL</h3>
	<p>
		<ul>
			<li><a href="./entity.html">外だしSQLの一件検索</a></li>
			<li><a href="./paging.html">外だしSQLのページング検索</a></li>
			<li><a href="./cursor.html">外だしSQLのカーソル検索</a></li>
			<li><a href="./dynamic.html">外だしSQLの動的バインド変数検索</a></li>
			<li><a href="./likesearch.html">外だしSQLの曖昧検索</a></li>
		</ul>	
	</p>
	<h3>パラメータコメント</h3>
	<p>
		パラメータコメントについては<a href="./pmcomment.html">こちら
	</p>
	
<!-- __content-end__ --></div>

<div id="sideBar">
	<h3>メインコンテンツ</h3>
	<ul>
		<li><a href="../setup/basic.html">DBFlute Setup</a></li>
		<ul>
			<li><a href="../setup/bytemplate.html">Template Setup</a></li>
			<li><a href="../setup/byemecha.html">EMecha Setup</a></li>
			<li><a href="../setup/logging.html">DBFlute Logging</a></li>
			<li><a href="../setup/versionup.html">DBFlute Version-up</a></li>
		</ul>
		<li><a href="../condition-bean/basic.html">ConditionBean</a></li>
		<li><a href="../outside-sql/basic.html">OutsideSql</a></li>
		<li><a href="../../ja/tips-behavior.html">Behavior</a></li>
		<li><a href="../dbvendor/basic.html">DB-Vendor Handling</a></li>
	</ul>
	<h3>トピックス</h3>
	<ul>
		<li><a href="../topic/csharpusers.html">To C# Users</a></li>
	</ul>
	<h3>その他いろいろ</h3>
	<ul>
		<li><a href="../various/sqllog.html">SqlLogRegistry</a></li>
	</ul>
</div>

<div id="footer">
<!-- 
	<ul>
		<li><a href="./sample.html">seasar</a></li>
		<li><a href="./sample.html">s2dao</a></li>
		<li><a href="./sample.html">teeda</a></li>
	</ul>
	 -->
</div>

</body>
</html>