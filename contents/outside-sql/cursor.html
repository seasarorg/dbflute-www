<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja" >
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<meta http-equiv="Content-Style-Type" content="text/css" />
	<style type="text/css" title="currentStyle">
		@import "../../css/main.css";
	</style>
	<title>DBFlute</title>
</head>
<body>

<div id="header">
	<h1><a href="../../index.html">DBFlute<span>現場指向O/Rマッパ</span></a></h1>
	<a href="../../index.html" class="logo"><img src="../../image/logo-content.gif" alt="dbflute logo"/></a>
</div>
<div id="content"><!-- __content-start__ -->
	<h2>外だしSQLのカーソル検索</h2>
	<p>
		検索結果をカーソル(ResultSet/DataReader)で扱うことのできるメソッドが存在します。
	</p>
	<p>
		大量件数を扱う場合は、検索結果を一気にメモリ上に展開するとメモリ不足になることがあります。<br />
		カーソル(ResultSet/DataReader)経由で１件ずつ処理をすることでその問題をそれを解決します。<br />
		一番わかりやすい例としては、「検索結果をそのままCSVファイルに出力する」というのが考えられるでしょう。
	</p>
	<h3>実装方法</h3>
	<p>
		outsideSql()メソッドの後、「cursorHandling()」メソッドを呼び出します。<br />
		すると、その後に「selectCursor()」メソッドが呼び出せます。
	</p>
	<p>
		「selectCursor()」メソッドの引数に指定するCursorHandlerでカーソル(ResultSet/DataReader)を扱うことが可能です。<br />
		「SQLのパス」や「ParameterBean」の仕様に関してはリスト検索と変わるところはありません。
		<pre><code>
final CursorHandler handler = ...;
memberBhv.cursorHandling().selectCursor(path, pmb, handler);
		</code></pre>
	</p>
	<p>
		CursorHandlerは、Sql2Entityでオプション指定することにより生成することができます。
		<pre>ex) Sql2Entityでカーソル指定
		<code>
-- #PurchaseSummaryMember#
-- +cursor+

-- !PurchaseSummaryMemberPmb!
-- !!String memberStatusCode!!

select member.MEMBER_ID
     , member.MEMBER_NAME
     , (select sum(purchase.PURCHASE_COUNT)
          from PURCHASE purchase
         where purchase.MEMBER_ID = member.MEMBER_ID
       ) as PURCHASE_SUMMARY
  from MEMBER member
 where member.MEMBER_STATUS_CODE = /*pmb.memberStatusCode*/'FML'
		</code>
		</pre>
	</p>
	<p>
		Sql2Entityの後、生成されたCursorHandlerのfetchCursor()メソッドをオーバーライドし、カーソルを扱います。<br />
		引数のCursorのnext()メソッドでループして１件ごとのデータを取得することが可能です。
		<pre>ex) 検索結果をCSVファイルへ出力する(ふり)<code>
final PurchaseSummaryMemberCursorHandler handler = new PurchaseSummaryMemberCursorHandler() {
    public Object fetchCursor(PurchaseSummaryMemberCursor cursor) throws SQLException {
        while (cursor.next()) {
            final Integer memberId = cursor.getMemberId();
            final String memberName = cursor.getMemberName();
            final Integer purchaseSummary = cursor.getPurchaseSummary();

            // ここではただログに出力するだけ
            // (本当はCSVファイルへの出力)
            _log.debug("  " + memberId + " - " + memberName + " - " + purchaseSummary);

        }// ResultSetのCloseはFrameworkが行うので必要なし
        return null;// ここで処理が完結してるので戻り値は不要
    }
};
memberBhv.outsideSql().cursorHandling().selectCursor(path, pmb, handler);
		</code></pre>
		それぞれのカラムの値の取得は、Sql2Entityで生成したクラスを利用していることによりタイプセーフです。<br />
		文字列の入力ミスによるSQL上の定義との食い違いでBUGが発生することはありません。<br />
		このCursorを「型付Cursor」と呼びます。型付でないCursorで扱うことも可能ですがお奨めしません。
	</p>
	<p>
		C#版での例題の実装は以下の通りです。<br />
		Javaとの違いは無名インナークラス(C#にはない)ではなく、匿名メソッド(Javaにはない)を使っているところです。
		<pre>ex) 検索結果をCSVファイルへ出力する(ふり) {C#}<code>
PurchaseSummaryMemberCursorHandler handler = new PurchaseSummaryMemberCursorHandler(
    delegate(PurchaseSummaryMemberCursor cursor) {
        while (cursor.Next()) {
            int? memberId = cursor.MemberId;
            String memberName = cursor.MemberName;
            decimal? purchaseSummary = cursor.PurchaseSummary;
            
            _log.Debug("  " + memberId + " - " + memberName + " - " + purchaseSummary);

        }// DataReaderのCloseはFrameworkが行うので必要なし
        return null;// ここで処理が完結してるので戻り値は不要
    });
memberBhv.OutsideSql().CursorHandling().SelectCursor(path, pmb, handler);
		</code></pre>
	</p>

<!-- __content-end__ --></div>

<div id="sideBar">
	<h3>Document</h3>
	<ul>
		<li><a href="../introduction/basic.html">DBFlute Introduction</a></li>
		<ul>
			<li><a href="../introduction/tutorial4developer.html">Tutorial(for Dev)</a></li>
		</ul>
		<li><a href="../setup/basic.html">DBFlute Setup</a></li>
		<ul>
			<li><a href="../setup/bytemplate.html">Template Setup</a></li>
			<li><a href="../setup/byemecha.html">EMecha Setup</a></li>
			<li><a href="../setup/aftersetup.html">After Setup</a></li>
			<li><a href="../setup/versionup.html">DBFlute Upgrade</a></li>
		</ul>
		<li><a href="../condition-bean/basic.html">ConditionBean</a></li>
		<ul>
			<li><a href="../condition-bean/cbscope.html">ConditionBean Scope</a></li>
			<li><a href="../condition-bean/cbredic.html">Reverse Dictionary</a></li>
		</ul>
		<li><a href="../outside-sql/basic.html">OutsideSql</a></li>
		<ul>
			<li><a href="../outside-sql/about.html">About OutsideSql</a></li>
			<li><a href="../outside-sql/pmcomment.html">Parameter Comment</a></li>
			<li><a href="../outside-sql/sql2entity.html">Sql2Entity</a></li>
			<li><a href="../outside-sql/entity.html">Entity Handling</a></li>
			<li><a href="../outside-sql/cursor.html">Cursor Handling</a></li>
			<li><a href="../outside-sql/dynamic.html">Dynamic Binding</a></li>
			<li><a href="../outside-sql/paging.html">Paging</a></li>
			<li><a href="../outside-sql/likesearch.html">Like Search</a></li>
		</ul>
		<li>Behavior</li>
		<li><a href="../dbvendor/basic.html">DB-Vendor Handling</a></li>
	</ul>
	<h3>Topics</h3>
	<ul>
		<li><a href="../topic/compwiths2dao.html">S2Dao Comparing</a></li>
		<li><a href="../topic/csharpusers.html">To C# Users</a></li>
	</ul>
	<h3>Various</h3>
	<ul>
		<li><a href="../various/sqllog.html">SqlLogRegistry</a></li>
	</ul>
</div>

<div id="footer">
<!-- 
	<ul>
		<li><a href="./sample.html">seasar</a></li>
		<li><a href="./sample.html">s2dao</a></li>
		<li><a href="./sample.html">teeda</a></li>
	</ul>
	 -->
</div>

</body>
</html>